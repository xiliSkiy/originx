# 图像/视频质量诊断系统 - 产品规划与改进建议

> 本文档从产品经理视角，梳理单机验证版的完整产品规划

## 一、目标用户与使用场景分析

### 1.1 目标用户画像

| 用户类型 | 典型场景 | 核心诉求 | 付费意愿 |
|----------|----------|----------|----------|
| **安防集成商** | 平安城市、雪亮工程 | 批量巡检、快速定位故障 | 高 |
| **视频监控平台** | 企业园区、工厂、校园 | 7×24小时自动巡检 | 中高 |
| **广电/媒体** | 直播、转播、节目制作 | 实时质量监控 | 高 |
| **交通部门** | 高速公路、城市交通 | 关键路段质量保障 | 高 |
| **金融机构** | 银行网点、ATM监控 | 合规性检查 | 中高 |
| **IDC/云服务商** | 视频云、监控托管 | 大规模自动化运维 | 高 |

### 1.2 使用场景细分

```
┌─────────────────────────────────────────────────────────────────────┐
│                         使用场景矩阵                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   场景一：离线批量检测                                               │
│   ├── 输入：图片文件夹 / 视频文件                                    │
│   ├── 输出：诊断报告（Excel/PDF/JSON）                              │
│   └── 典型用户：运维人员定期巡检                                     │
│                                                                     │
│   场景二：实时流检测                                                 │
│   ├── 输入：RTSP/RTMP/HLS 视频流                                    │
│   ├── 输出：实时告警 + 异常截图                                      │
│   └── 典型用户：监控中心值班人员                                     │
│                                                                     │
│   场景三：API集成调用                                                │
│   ├── 输入：图片URL / Base64 / 视频流地址                           │
│   ├── 输出：JSON格式诊断结果                                        │
│   └── 典型用户：第三方平台集成                                       │
│                                                                     │
│   场景四：定时巡检任务                                               │
│   ├── 输入：设备列表 + 巡检计划                                      │
│   ├── 输出：巡检报告 + 异常告警                                      │
│   └── 典型用户：无人值守场景                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 二、功能优先级规划（MoSCoW 分析）

### 2.1 单机验证版 MVP 功能清单

| 优先级 | 功能模块 | 功能点 | 说明 |
|--------|----------|--------|------|
| **Must Have** | 图像诊断 | 模糊检测 | 核心功能，必须有 |
| **Must Have** | 图像诊断 | 亮度异常（过亮/过暗） | 核心功能 |
| **Must Have** | 图像诊断 | 颜色异常（偏色/黑白/蓝屏） | 核心功能 |
| **Must Have** | 图像诊断 | 噪声检测（雪花/噪点） | 核心功能 |
| **Must Have** | 基础能力 | 单图检测 API | 最小可用 |
| **Must Have** | 基础能力 | 批量图片检测 | 验证效率 |
| **Must Have** | 结果输出 | JSON 格式结果 | 便于集成 |
| **Should Have** | 图像诊断 | 对比度异常 | 重要补充 |
| **Should Have** | 图像诊断 | 条纹干扰 | 常见问题 |
| **Should Have** | 图像诊断 | 遮挡检测 | 安防刚需 |
| **Should Have** | 视频诊断 | 画面冻结 | 视频核心 |
| **Should Have** | 视频诊断 | 信号丢失/黑屏 | 视频核心 |
| **Should Have** | 结果输出 | HTML 报告 | 可视化验证 |
| **Should Have** | 基础能力 | 视频文件检测 | 扩展场景 |
| **Could Have** | 视频诊断 | 场景变换 | 进阶功能 |
| **Could Have** | 视频诊断 | 视频抖动 | 进阶功能 |
| **Could Have** | 流媒体 | RTSP 流检测 | 实时场景 |
| **Could Have** | 管理界面 | Web UI | 易用性 |
| **Won't Have (V1)** | 分布式 | 集群部署 | 后续版本 |
| **Won't Have (V1)** | 高级功能 | 深度学习模型 | 后续版本 |

### 2.2 MVP 功能边界图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        MVP 功能边界                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    ✅ MVP 必须包含                           │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│   │  │ 模糊检测 │ │ 亮度分析 │ │ 颜色分析 │ │ 噪声检测 │       │   │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │   │
│   │  │ 单图API  │ │ 批量检测 │ │ JSON输出 │                    │   │
│   │  └──────────┘ └──────────┘ └──────────┘                    │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    ⚡ 第二优先级                             │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│   │  │ 画面冻结 │ │ 信号丢失 │ │ 遮挡检测 │ │ 条纹干扰 │       │   │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│   │  ┌──────────┐ ┌──────────┐                                  │   │
│   │  │ 视频文件 │ │ HTML报告 │                                  │   │
│   │  └──────────┘ └──────────┘                                  │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    🔮 后续版本                               │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│   │  │ RTSP流   │ │ Web UI   │ │ 定时任务 │ │ 告警推送 │       │   │
│   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐                    │   │
│   │  │ 深度学习 │ │ 分布式   │ │ 多租户   │                    │   │
│   │  └──────────┘ └──────────┘ └──────────┘                    │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 三、容易被忽视的关键考虑点

### 3.1 🎯 诊断结果的置信度与阈值管理

**问题**：不同场景对"异常"的定义不同

```
示例：
- 银行ATM监控：轻微模糊就需要告警
- 户外道路监控：雨天轻微模糊是正常的
- 夜间监控：画面较暗是预期行为
```

**建议方案**：

```yaml
# 阈值配置示例
detection_profiles:
  strict:  # 严格模式（银行、金融）
    blur_threshold: 50
    brightness_min: 30
    brightness_max: 220
    
  normal:  # 标准模式（园区、企业）
    blur_threshold: 100
    brightness_min: 20
    brightness_max: 235
    
  loose:   # 宽松模式（户外、复杂环境）
    blur_threshold: 150
    brightness_min: 10
    brightness_max: 245

  custom:  # 自定义模式
    # 用户可自定义所有阈值
```

**产品设计要点**：
1. 提供预设配置模板（严格/标准/宽松）
2. 支持自定义阈值配置
3. 每个诊断结果返回置信度分数（0-100）
4. 支持按场景/设备组配置不同阈值

---

### 3.2 🎯 诊断结果的可解释性

**问题**：用户不仅需要知道"有问题"，还需要知道"为什么"

**建议方案**：

```json
{
  "diagnosis": "blur",
  "is_abnormal": true,
  "confidence": 0.87,
  "score": 45.2,
  "threshold": 100,
  "severity": "high",
  "explanation": "图像清晰度评分45.2，低于阈值100，判定为模糊",
  "possible_causes": [
    "镜头脏污",
    "对焦不准",
    "运动模糊"
  ],
  "suggestions": [
    "检查并清洁镜头",
    "调整摄像头对焦",
    "检查摄像头固定是否稳固"
  ],
  "evidence": {
    "laplacian_variance": 45.2,
    "gradient_score": 38.7,
    "edge_density": 0.12
  }
}
```

---

### 3.3 🎯 多指标联合诊断与冲突处理

**问题**：多个指标可能相互影响或冲突

```
示例冲突：
- 夜间画面 → 同时触发"过暗"和"低对比度"（实际是同一问题）
- 黑屏 → 同时触发"过暗"、"无纹理"、"模糊"（应该只报黑屏）
- 蓝屏 → 同时触发"偏色"、"低对比度"（应该只报蓝屏）
```

**建议方案**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      诊断优先级与抑制规则                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   优先级从高到低：                                                   │
│   1. 信号丢失（黑屏）  ──抑制──> 过暗、模糊、低对比度               │
│   2. 蓝屏/绿屏        ──抑制──> 偏色、低对比度                      │
│   3. 雪花/噪声严重     ──抑制──> 模糊                               │
│   4. 遮挡（大面积）    ──抑制──> 局部模糊                           │
│   5. 其他独立指标      ──正常报告                                   │
│                                                                     │
│   输出示例：                                                         │
│   {                                                                 │
│     "primary_issue": "signal_loss",                                │
│     "suppressed_issues": ["too_dark", "blur", "low_contrast"],     │
│     "independent_issues": []                                        │
│   }                                                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.4 🎯 基准图像对比（非常重要！）

**问题**：很多异常需要和"正常状态"对比才能判断

```
示例：
- 遮挡检测：需要知道原本画面应该是什么样
- 场景变换：需要知道原始场景
- PTZ摄像头：不同角度画面差异很大
```

**建议方案**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      基准图像管理机制                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   方式一：手动设置基准                                               │
│   ├── 用户上传标准画面作为基准                                       │
│   └── 适用于固定摄像头                                              │
│                                                                     │
│   方式二：自动学习基准                                               │
│   ├── 系统收集一段时间的正常画面                                     │
│   ├── 自动生成基准特征（不存储原图，节省空间）                        │
│   └── 适用于大规模部署                                              │
│                                                                     │
│   方式三：时间窗口对比                                               │
│   ├── 与前N分钟/N小时的画面对比                                      │
│   └── 适用于场景变换、突变检测                                       │
│                                                                     │
│   方式四：相邻摄像头对比                                             │
│   ├── 同区域多摄像头横向对比                                        │
│   └── 适用于大面积异常检测（如雾霾）                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 🎯 时间维度分析

**问题**：很多问题只在时间维度才能发现

```
示例：
- 画面冻结：单帧无法判断，需要连续多帧
- 频闪：需要分析亮度变化周期
- 间歇性故障：偶发性问题需要历史记录
```

**建议方案**：

```python
# 时间窗口分析配置
time_analysis:
  # 短时分析（秒级）
  short_term:
    window_size: 10  # 10帧
    metrics:
      - freeze_detection
      - flicker_detection
      - sudden_change
  
  # 中时分析（分钟级）  
  mid_term:
    window_size: 300  # 5分钟
    metrics:
      - intermittent_issues
      - quality_trend
      
  # 长时分析（小时/天级）
  long_term:
    window_size: 3600  # 1小时
    metrics:
      - daily_pattern
      - degradation_trend
```

---

### 3.6 🎯 性能与资源权衡

**问题**：检测越全面，消耗资源越多

**建议方案**：分级检测策略

```
┌─────────────────────────────────────────────────────────────────────┐
│                      分级检测策略                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Level 1: 快速筛查（<5ms/帧）                                       │
│   ├── 亮度均值                                                      │
│   ├── 简单模糊检测                                                  │
│   └── 主色调分析                                                    │
│   适用：全量实时检测                                                 │
│                                                                     │
│   Level 2: 标准检测（<20ms/帧）                                      │
│   ├── 完整模糊检测                                                  │
│   ├── 噪声检测                                                      │
│   ├── 对比度分析                                                    │
│   └── 条纹检测                                                      │
│   适用：定时巡检、抽样检测                                           │
│                                                                     │
│   Level 3: 深度分析（<100ms/帧）                                     │
│   ├── 遮挡检测                                                      │
│   ├── 场景对比                                                      │
│   ├── AI辅助分析                                                    │
│   └── 多帧联合分析                                                  │
│   适用：异常确认、问题诊断                                           │
│                                                                     │
│   自适应策略：                                                       │
│   正常情况 → Level 1                                                │
│   发现可疑 → 升级到 Level 2                                         │
│   确认异常 → 升级到 Level 3                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 🎯 结果存储与查询

**问题**：诊断结果如何存储和查询

**建议方案**：

```sql
-- 核心数据表设计

-- 诊断任务表
CREATE TABLE diagnosis_tasks (
    id BIGINT PRIMARY KEY,
    task_type ENUM('image', 'video', 'stream'),
    source_type ENUM('file', 'url', 'rtsp'),
    source_path TEXT,
    status ENUM('pending', 'running', 'completed', 'failed'),
    created_at TIMESTAMP,
    completed_at TIMESTAMP,
    config_profile VARCHAR(50)  -- 使用的配置模板
);

-- 诊断结果表
CREATE TABLE diagnosis_results (
    id BIGINT PRIMARY KEY,
    task_id BIGINT,
    frame_index INT,           -- 视频帧序号
    timestamp TIMESTAMP,
    
    -- 各指标得分
    blur_score FLOAT,
    brightness_score FLOAT,
    contrast_score FLOAT,
    color_score FLOAT,
    noise_score FLOAT,
    
    -- 异常标记
    is_abnormal BOOLEAN,
    abnormal_types JSON,       -- ["blur", "too_dark"]
    primary_issue VARCHAR(50),
    
    -- 详细信息
    details JSON,
    thumbnail_path TEXT,       -- 缩略图路径
    
    INDEX idx_task_abnormal (task_id, is_abnormal),
    INDEX idx_timestamp (timestamp)
);

-- 告警记录表
CREATE TABLE alerts (
    id BIGINT PRIMARY KEY,
    result_id BIGINT,
    device_id VARCHAR(100),
    alert_type VARCHAR(50),
    severity ENUM('info', 'warning', 'critical'),
    message TEXT,
    acknowledged BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP
);
```

---

### 3.8 🎯 异常样本收集（为后续优化铺垫）

**问题**：算法需要持续优化，需要积累样本

**建议方案**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      样本收集机制                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   自动收集：                                                         │
│   ├── 检测到异常 → 自动保存原图 + 诊断结果                           │
│   ├── 置信度在边界区间 → 保存待人工复核                              │
│   └── 用户反馈"误报" → 保存为负样本                                 │
│                                                                     │
│   样本分类：                                                         │
│   ├── confirmed_positive/  # 确认的异常样本                         │
│   ├── confirmed_negative/  # 确认的正常样本                         │
│   ├── pending_review/      # 待复核样本                             │
│   └── false_positive/      # 误报样本                               │
│                                                                     │
│   用途：                                                             │
│   ├── 阈值调优                                                      │
│   ├── 算法评测                                                      │
│   └── 未来训练深度学习模型                                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.9 🎯 测试与评估体系

**问题**：如何验证算法效果

**建议方案**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      算法评估指标                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   准确性指标：                                                       │
│   ├── 准确率 (Accuracy)                                             │
│   ├── 召回率 (Recall) - 漏检率的补数                                │
│   ├── 精确率 (Precision) - 误报率的补数                             │
│   ├── F1-Score                                                      │
│   └── AUC-ROC                                                       │
│                                                                     │
│   性能指标：                                                         │
│   ├── 单帧处理时间 (ms)                                             │
│   ├── 吞吐量 (fps)                                                  │
│   ├── CPU 占用率                                                    │
│   ├── 内存占用                                                      │
│   └── GPU 利用率（如使用）                                          │
│                                                                     │
│   标准测试集：                                                       │
│   ├── 正常样本：1000张（各场景覆盖）                                │
│   ├── 模糊样本：200张（不同程度）                                   │
│   ├── 亮度异常：200张（过亮/过暗）                                  │
│   ├── 颜色异常：200张（偏色/黑白/蓝屏）                             │
│   ├── 噪声样本：200张                                               │
│   └── 其他异常：每类100张                                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.10 🎯 配置与部署

**问题**：如何让用户快速上手

**建议方案**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      快速部署设计                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   部署方式（按易用性排序）：                                          │
│                                                                     │
│   1. Docker 一键部署 ⭐推荐                                          │
│      docker run -p 8080:8080 originx/video-diagnosis                │
│                                                                     │
│   2. 可执行文件                                                      │
│      ./originx-server --config config.yaml                          │
│                                                                     │
│   3. Python 包安装                                                   │
│      pip install originx                                            │
│      originx serve --port 8080                                      │
│                                                                     │
│   4. 源码部署                                                        │
│      git clone ... && pip install -r requirements.txt               │
│      python -m api.main                                             │
│                                                                     │
│   配置文件示例 (config.yaml)：                                       │
│   server:                                                           │
│     host: 0.0.0.0                                                   │
│     port: 8080                                                      │
│     workers: 4                                                      │
│                                                                     │
│   detection:                                                        │
│     profile: normal                                                 │
│     gpu_enabled: false                                              │
│                                                                     │
│   storage:                                                          │
│     result_dir: ./results                                           │
│     keep_days: 30                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 四、单机验证版交付物清单

### 4.1 必须交付

| 交付物 | 说明 | 优先级 |
|--------|------|--------|
| 核心检测库 | Python/C++ 算法实现 | P0 |
| REST API 服务 | HTTP 接口 | P0 |
| CLI 命令行工具 | 便于测试验证 | P0 |
| API 文档 | Swagger/OpenAPI | P0 |
| 使用说明 | README + 快速开始 | P0 |
| 示例代码 | 调用示例 | P0 |
| 测试用例 | 单元测试 + 集成测试 | P0 |
| Docker 镜像 | 一键部署 | P1 |

### 4.2 建议交付

| 交付物 | 说明 | 优先级 |
|--------|------|--------|
| 简易 Web UI | 可视化验证 | P1 |
| 性能基准报告 | 测试结果 | P1 |
| 配置模板 | 多场景预设 | P1 |
| 标准测试集 | 验证准确性 | P2 |

## 五、用户体验设计建议

### 5.1 API 设计原则

```
✅ RESTful 风格
✅ 统一的错误码和错误信息
✅ 支持同步和异步两种模式
✅ 合理的超时和重试机制
✅ 请求/响应压缩
✅ API 版本管理 (v1, v2...)
```

### 5.2 响应设计

```json
// 成功响应
{
  "code": 0,
  "message": "success",
  "data": {
    "task_id": "xxx",
    "is_abnormal": true,
    "issues": [...],
    "scores": {...}
  },
  "meta": {
    "process_time_ms": 45,
    "version": "1.0.0"
  }
}

// 错误响应
{
  "code": 40001,
  "message": "Invalid image format",
  "details": "Only JPEG, PNG, BMP formats are supported",
  "request_id": "xxx"
}
```

### 5.3 CLI 设计

```bash
# 单图检测
originx detect image ./test.jpg

# 批量检测
originx detect batch ./images/ --output ./results/

# 视频检测
originx detect video ./test.mp4 --sample-rate 1

# 启动服务
originx serve --port 8080 --workers 4

# 查看配置
originx config show

# 性能测试
originx benchmark --images ./test_set/
```

## 六、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 误报率高 | 用户信任度下降 | 提供置信度、支持阈值调整、收集误报样本优化 |
| 漏检 | 关键问题未发现 | 提供多级检测、支持严格模式 |
| 性能不达标 | 无法满足实时性 | 分级检测策略、关键算法C++优化 |
| 场景适配性差 | 特定场景效果不好 | 收集多场景样本、支持场景化配置 |
| 集成困难 | 客户接入成本高 | 提供多语言SDK、详细文档、示例代码 |

## 七、后续版本规划

```
V1.0 单机验证版（当前）
├── 核心图像检测
├── 基础视频检测
└── API + CLI

V1.5 增强版
├── Web 管理界面
├── 定时任务
├── 告警通知
└── 更多检测指标

V2.0 企业版
├── RTSP/RTMP 实时流
├── 多路并发
├── 分布式部署
└── 权限管理

V3.0 平台版
├── 边缘-云协同
├── 百万点位支撑
├── 多租户
└── AI 增强检测
```

## 八、总结：MVP 核心关注点

```
┌─────────────────────────────────────────────────────────────────────┐
│                    MVP 成功的关键因素                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1. 🎯 准确性 > 全面性                                             │
│      先把核心指标做准，再扩展更多指标                                 │
│                                                                     │
│   2. 🎯 可配置性                                                    │
│      阈值可调、模式可选、适应不同场景                                 │
│                                                                     │
│   3. 🎯 可解释性                                                    │
│      告诉用户为什么、怎么办                                          │
│                                                                     │
│   4. 🎯 易用性                                                      │
│      5分钟能跑起来，10分钟能集成                                     │
│                                                                     │
│   5. 🎯 可扩展性                                                    │
│      架构为后续扩展留好接口                                          │
│                                                                     │
│   6. 🎯 样本积累                                                    │
│      为后续优化积累数据                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

