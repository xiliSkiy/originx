# 图像/视频质量诊断系统 - 单机版系统设计 V1.0

> 本文档为单机验证版的详细系统设计，融合产品规划中的改进建议

## 一、设计目标与约束

### 1.1 设计目标

| 目标 | 指标 | 说明 |
|------|------|------|
| **性能** | 单图 < 50ms | 1080P图像，CPU模式 |
| **吞吐** | > 20 fps | 单机处理能力 |
| **准确率** | > 95% | 核心指标（模糊/亮度/颜色） |
| **误报率** | < 5% | 标准模式下 |
| **易用性** | 5分钟上手 | 从下载到运行 |
| **可扩展** | 插件化 | 便于新增检测器 |

### 1.2 设计约束

```
┌─────────────────────────────────────────────────────────────────────┐
│                         设计约束条件                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   环境约束：                                                         │
│   ├── 单机部署，不依赖外部服务（数据库可选）                          │
│   ├── 支持 Linux / macOS / Windows                                  │
│   ├── CPU 模式为主，GPU 可选加速                                     │
│   └── Python 3.9+                                                   │
│                                                                     │
│   资源约束：                                                         │
│   ├── 内存占用 < 2GB（基础运行）                                     │
│   ├── 磁盘占用 < 500MB（不含结果存储）                               │
│   └── 无需联网运行                                                   │
│                                                                     │
│   功能约束：                                                         │
│   ├── V1.0 聚焦图像检测，视频检测为可选                              │
│   ├── 不包含深度学习模型（传统CV算法为主）                           │
│   └── 不包含分布式能力                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 二、系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          OriginX 单机版架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         接入层 (Entry Layer)                         │   │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │   │
│   │   │  REST API   │   │     CLI     │   │  Python SDK │              │   │
│   │   │  (FastAPI)  │   │   (Click)   │   │   (直接调用) │              │   │
│   │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘              │   │
│   └──────────┼─────────────────┼─────────────────┼──────────────────────┘   │
│              │                 │                 │                          │
│              └─────────────────┼─────────────────┘                          │
│                                ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        服务层 (Service Layer)                        │   │
│   │                                                                     │   │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │   │
│   │   │  DiagnosisService│  │  ConfigService  │  │  ReportService  │    │   │
│   │   │  诊断调度服务     │  │  配置管理服务    │  │  报告生成服务    │    │   │
│   │   └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │   │
│   │            │                    │                    │              │   │
│   └────────────┼────────────────────┼────────────────────┼──────────────┘   │
│                │                    │                    │                  │
│                ▼                    ▼                    ▼                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        核心层 (Core Layer)                           │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐    │   │
│   │   │                    Pipeline (检测流水线)                    │    │   │
│   │   │   ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐       │    │   │
│   │   │   │预处理│→│检测器│→│后处理│→│聚合器│→│输出器│       │    │   │
│   │   │   └──────┘  └──────┘  └──────┘  └──────┘  └──────┘       │    │   │
│   │   └───────────────────────────────────────────────────────────┘    │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐  │   │
│   │   │                      检测器注册表 (Detector Registry)         │  │   │
│   │   │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │  │   │
│   │   │  │  Blur  │ │Bright- │ │ Color  │ │ Noise  │ │Contrast│   │  │   │
│   │   │  │Detector│ │ness    │ │Analyzer│ │Detector│ │Analyzer│   │  │   │
│   │   │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘   │  │   │
│   │   │  ┌────────┐ ┌────────┐ ┌────────┐                         │  │   │
│   │   │  │ Stripe │ │Occlus- │ │ Signal │  ... (可扩展)           │  │   │
│   │   │  │Detector│ │ion     │ │ Loss   │                         │  │   │
│   │   │  └────────┘ └────────┘ └────────┘                         │  │   │
│   │   └─────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       基础层 (Infrastructure Layer)                  │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │
│   │   │ Storage  │  │  Logger  │  │  Config  │  │  Utils   │           │   │
│   │   │ 存储管理  │  │  日志    │  │  配置    │  │  工具    │           │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责说明

| 层级 | 模块 | 职责 | 依赖 |
|------|------|------|------|
| **接入层** | REST API | 提供HTTP接口，支持同步/异步 | Service Layer |
| | CLI | 命令行工具 | Service Layer |
| | Python SDK | 直接调用接口 | Service Layer |
| **服务层** | DiagnosisService | 诊断任务调度、结果聚合 | Core Layer |
| | ConfigService | 配置加载、阈值管理、Profile管理 | Infrastructure |
| | ReportService | 报告生成（JSON/HTML/Excel） | Storage |
| **核心层** | Pipeline | 检测流水线编排 | Detectors |
| | Detectors | 各类检测器实现 | Utils |
| | Aggregator | 多指标聚合、冲突处理 | Config |
| **基础层** | Storage | 结果存储、样本管理 | - |
| | Logger | 日志记录 | - |
| | Config | 配置解析 | - |
| | Utils | 图像处理工具函数 | OpenCV |

### 2.3 数据流设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流向图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   输入                                                                       │
│   ┌─────────┐                                                               │
│   │ 图片文件 │──┐                                                           │
│   └─────────┘  │    ┌──────────────┐                                       │
│   ┌─────────┐  ├───→│  InputLoader │                                       │
│   │图片URL  │──┤    │  输入加载器   │                                       │
│   └─────────┘  │    └──────┬───────┘                                       │
│   ┌─────────┐  │           │                                               │
│   │Base64   │──┘           ▼                                               │
│   └─────────┘       ┌──────────────┐                                       │
│                     │ Preprocessor │                                       │
│                     │  预处理器     │                                       │
│                     │ • 解码       │                                       │
│                     │ • 缩放       │                                       │
│                     │ • 色彩转换   │                                       │
│                     └──────┬───────┘                                       │
│                            │                                               │
│                            ▼                                               │
│                     ┌──────────────────────────────────────────────┐       │
│                     │              Detector Pipeline                │       │
│                     │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐│       │
│                     │  │ Blur   │ │Bright  │ │ Color  │ │ Noise  ││       │
│                     │  │        │ │ness    │ │        │ │        ││       │
│                     │  └───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘│       │
│                     │      │          │          │          │      │       │
│                     └──────┼──────────┼──────────┼──────────┼──────┘       │
│                            │          │          │          │              │
│                            ▼          ▼          ▼          ▼              │
│                     ┌──────────────────────────────────────────────┐       │
│                     │              Result Aggregator                │       │
│                     │  • 收集各检测器结果                           │       │
│                     │  • 应用优先级规则                             │       │
│                     │  • 处理指标冲突                               │       │
│                     │  • 生成最终诊断                               │       │
│                     └──────────────────┬───────────────────────────┘       │
│                                        │                                   │
│                            ┌───────────┼───────────┐                       │
│                            ▼           ▼           ▼                       │
│                     ┌──────────┐ ┌──────────┐ ┌──────────┐                │
│   输出              │ JSON     │ │ 存储     │ │ 样本     │                │
│                     │ Response │ │ Result   │ │ 收集     │                │
│                     └──────────┘ └──────────┘ └──────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 三、核心模块详细设计

### 3.1 检测器设计（插件化架构）

#### 3.1.1 检测器基类

```python
# core/base.py

from abc import ABC, abstractmethod
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional
from enum import Enum
import numpy as np


class Severity(Enum):
    """异常严重程度"""
    NORMAL = "normal"      # 正常
    INFO = "info"          # 提示
    WARNING = "warning"    # 警告
    CRITICAL = "critical"  # 严重


class DetectionLevel(Enum):
    """检测级别"""
    FAST = 1      # 快速筛查 (<5ms)
    STANDARD = 2  # 标准检测 (<20ms)
    DEEP = 3      # 深度分析 (<100ms)


@dataclass
class DetectionResult:
    """单个检测器的结果"""
    detector_name: str           # 检测器名称
    issue_type: str              # 问题类型 (blur, too_dark, etc.)
    is_abnormal: bool            # 是否异常
    score: float                 # 原始得分
    threshold: float             # 使用的阈值
    confidence: float            # 置信度 (0-1)
    severity: Severity           # 严重程度
    
    # 可解释性字段
    explanation: str = ""                           # 解释说明
    possible_causes: List[str] = field(default_factory=list)  # 可能原因
    suggestions: List[str] = field(default_factory=list)      # 建议措施
    evidence: Dict[str, Any] = field(default_factory=dict)    # 证据数据
    
    # 元数据
    process_time_ms: float = 0   # 处理耗时
    detection_level: DetectionLevel = DetectionLevel.STANDARD


class BaseDetector(ABC):
    """检测器基类 - 所有检测器必须继承此类"""
    
    # 检测器元信息
    name: str = "base_detector"
    display_name: str = "基础检测器"
    description: str = ""
    version: str = "1.0.0"
    
    # 支持的检测级别
    supported_levels: List[DetectionLevel] = [DetectionLevel.STANDARD]
    
    # 优先级 (数字越小优先级越高，用于冲突处理)
    priority: int = 100
    
    # 该检测器会抑制哪些其他检测器
    suppresses: List[str] = []
    
    def __init__(self, config: Dict[str, Any] = None):
        self.config = config or {}
        self._load_thresholds()
    
    def _load_thresholds(self):
        """从配置加载阈值"""
        pass
    
    @abstractmethod
    def detect(
        self, 
        image: np.ndarray,
        level: DetectionLevel = DetectionLevel.STANDARD
    ) -> DetectionResult:
        """
        执行检测
        
        Args:
            image: BGR格式的图像数组
            level: 检测级别
            
        Returns:
            DetectionResult: 检测结果
        """
        pass
    
    def get_explanation(self, result: DetectionResult) -> str:
        """生成解释说明"""
        if result.is_abnormal:
            return f"{self.display_name}检测异常: 得分{result.score:.1f}, 阈值{result.threshold:.1f}"
        return f"{self.display_name}检测正常: 得分{result.score:.1f}"
    
    def get_possible_causes(self, result: DetectionResult) -> List[str]:
        """获取可能原因"""
        return []
    
    def get_suggestions(self, result: DetectionResult) -> List[str]:
        """获取建议措施"""
        return []
```

#### 3.1.2 检测器注册表

```python
# core/registry.py

from typing import Dict, Type, List, Optional
from .base import BaseDetector, DetectionLevel


class DetectorRegistry:
    """检测器注册表 - 管理所有检测器的注册和获取"""
    
    _detectors: Dict[str, Type[BaseDetector]] = {}
    _instances: Dict[str, BaseDetector] = {}
    
    @classmethod
    def register(cls, detector_class: Type[BaseDetector]) -> Type[BaseDetector]:
        """
        注册检测器（可作为装饰器使用）
        
        @DetectorRegistry.register
        class BlurDetector(BaseDetector):
            ...
        """
        cls._detectors[detector_class.name] = detector_class
        return detector_class
    
    @classmethod
    def get(cls, name: str, config: Dict = None) -> Optional[BaseDetector]:
        """获取检测器实例（单例模式）"""
        if name not in cls._detectors:
            return None
        
        cache_key = f"{name}_{hash(str(config))}"
        if cache_key not in cls._instances:
            cls._instances[cache_key] = cls._detectors[name](config)
        
        return cls._instances[cache_key]
    
    @classmethod
    def get_all(cls, config: Dict = None) -> List[BaseDetector]:
        """获取所有已注册的检测器"""
        return [cls.get(name, config) for name in cls._detectors]
    
    @classmethod
    def get_by_level(
        cls, 
        level: DetectionLevel,
        config: Dict = None
    ) -> List[BaseDetector]:
        """根据检测级别获取检测器"""
        detectors = []
        for name, detector_class in cls._detectors.items():
            if level in detector_class.supported_levels:
                detectors.append(cls.get(name, config))
        return sorted(detectors, key=lambda d: d.priority)
    
    @classmethod
    def list_detectors(cls) -> List[Dict]:
        """列出所有检测器信息"""
        return [
            {
                "name": d.name,
                "display_name": d.display_name,
                "description": d.description,
                "version": d.version,
                "priority": d.priority,
                "supported_levels": [l.name for l in d.supported_levels]
            }
            for d in cls._detectors.values()
        ]
```

#### 3.1.3 具体检测器实现示例

```python
# core/detectors/blur_detector.py

import cv2
import numpy as np
from typing import Dict, Any, List
from ..base import BaseDetector, DetectionResult, Severity, DetectionLevel
from ..registry import DetectorRegistry


@DetectorRegistry.register
class BlurDetector(BaseDetector):
    """模糊检测器"""
    
    name = "blur"
    display_name = "图像模糊检测"
    description = "检测图像是否存在模糊问题，支持运动模糊和对焦模糊"
    version = "1.0.0"
    
    supported_levels = [
        DetectionLevel.FAST,
        DetectionLevel.STANDARD,
        DetectionLevel.DEEP
    ]
    
    priority = 50  # 中等优先级
    suppresses = []  # 不抑制其他检测器
    
    # 默认阈值
    DEFAULT_THRESHOLDS = {
        "strict": 50,
        "normal": 100,
        "loose": 150
    }
    
    def __init__(self, config: Dict[str, Any] = None):
        super().__init__(config)
        self.threshold = self.config.get(
            "blur_threshold", 
            self.DEFAULT_THRESHOLDS["normal"]
        )
    
    def detect(
        self,
        image: np.ndarray,
        level: DetectionLevel = DetectionLevel.STANDARD
    ) -> DetectionResult:
        """执行模糊检测"""
        import time
        start_time = time.time()
        
        # 根据检测级别选择算法
        if level == DetectionLevel.FAST:
            score, evidence = self._fast_detect(image)
        elif level == DetectionLevel.STANDARD:
            score, evidence = self._standard_detect(image)
        else:
            score, evidence = self._deep_detect(image)
        
        # 判断是否异常
        is_abnormal = score < self.threshold
        
        # 计算置信度 (基于距离阈值的远近)
        distance_ratio = abs(score - self.threshold) / self.threshold
        confidence = min(1.0, distance_ratio)
        
        # 确定严重程度
        severity = self._calculate_severity(score)
        
        process_time = (time.time() - start_time) * 1000
        
        result = DetectionResult(
            detector_name=self.name,
            issue_type="blur",
            is_abnormal=is_abnormal,
            score=score,
            threshold=self.threshold,
            confidence=confidence,
            severity=severity,
            evidence=evidence,
            process_time_ms=process_time,
            detection_level=level
        )
        
        # 填充可解释性字段
        result.explanation = self.get_explanation(result)
        result.possible_causes = self.get_possible_causes(result)
        result.suggestions = self.get_suggestions(result)
        
        return result
    
    def _fast_detect(self, image: np.ndarray) -> tuple:
        """快速检测 - 仅使用Laplacian方差"""
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
        laplacian_var = cv2.Laplacian(gray, cv2.CV_64F).var()
        
        return laplacian_var, {"laplacian_variance": laplacian_var}
    
    def _standard_detect(self, image: np.ndarray) -> tuple:
        """标准检测 - Laplacian + Sobel"""
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
        
        # Laplacian方差
        laplacian_var = cv2.Laplacian(gray, cv2.CV_64F).var()
        
        # Sobel梯度
        sobelx = cv2.Sobel(gray, cv2.CV_64F, 1, 0, ksize=3)
        sobely = cv2.Sobel(gray, cv2.CV_64F, 0, 1, ksize=3)
        gradient_magnitude = np.sqrt(sobelx**2 + sobely**2)
        gradient_mean = gradient_magnitude.mean()
        
        # 综合得分
        score = laplacian_var * 0.6 + gradient_mean * 0.4
        
        evidence = {
            "laplacian_variance": laplacian_var,
            "gradient_mean": gradient_mean,
            "combined_score": score
        }
        
        return score, evidence
    
    def _deep_detect(self, image: np.ndarray) -> tuple:
        """深度检测 - 多尺度分析"""
        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
        
        scores = []
        evidence = {}
        
        # 多尺度分析
        for scale in [1.0, 0.5, 0.25]:
            if scale != 1.0:
                h, w = gray.shape
                resized = cv2.resize(gray, (int(w*scale), int(h*scale)))
            else:
                resized = gray
            
            lap_var = cv2.Laplacian(resized, cv2.CV_64F).var()
            scores.append(lap_var)
            evidence[f"laplacian_scale_{scale}"] = lap_var
        
        # 边缘密度
        edges = cv2.Canny(gray, 50, 150)
        edge_density = np.count_nonzero(edges) / edges.size
        evidence["edge_density"] = edge_density
        
        # Brenner梯度
        brenner = self._brenner_gradient(gray)
        evidence["brenner_gradient"] = brenner
        
        # 综合得分
        score = np.mean(scores) * 0.5 + brenner * 0.3 + edge_density * 1000 * 0.2
        evidence["final_score"] = score
        
        return score, evidence
    
    def _brenner_gradient(self, gray: np.ndarray) -> float:
        """Brenner梯度计算"""
        diff = gray[:, 2:].astype(float) - gray[:, :-2].astype(float)
        return np.mean(diff ** 2)
    
    def _calculate_severity(self, score: float) -> Severity:
        """计算严重程度"""
        if score >= self.threshold:
            return Severity.NORMAL
        elif score >= self.threshold * 0.7:
            return Severity.INFO
        elif score >= self.threshold * 0.4:
            return Severity.WARNING
        else:
            return Severity.CRITICAL
    
    def get_possible_causes(self, result: DetectionResult) -> List[str]:
        if not result.is_abnormal:
            return []
        
        causes = ["镜头脏污或有水渍", "摄像头对焦不准确"]
        
        # 根据证据推断更具体的原因
        if result.evidence.get("edge_density", 1) < 0.05:
            causes.append("可能存在大面积平滑区域或遮挡")
        
        if result.severity == Severity.CRITICAL:
            causes.append("镜头可能损坏")
            causes.append("运动模糊（摄像头晃动）")
        
        return causes
    
    def get_suggestions(self, result: DetectionResult) -> List[str]:
        if not result.is_abnormal:
            return []
        
        suggestions = ["检查并清洁摄像头镜头"]
        
        if result.severity in [Severity.WARNING, Severity.CRITICAL]:
            suggestions.extend([
                "调整摄像头对焦设置",
                "检查摄像头固定是否稳固",
                "检查摄像头是否需要更换"
            ])
        
        return suggestions
```

### 3.2 检测流水线设计

```python
# core/pipeline.py

from dataclasses import dataclass, field
from typing import Dict, List, Optional, Any
import numpy as np
from concurrent.futures import ThreadPoolExecutor
import time

from .base import DetectionResult, DetectionLevel, Severity
from .registry import DetectorRegistry


@dataclass
class DiagnosisResult:
    """完整诊断结果"""
    # 基本信息
    image_id: str = ""
    image_path: str = ""
    image_size: tuple = (0, 0)
    
    # 总体判断
    is_abnormal: bool = False
    primary_issue: Optional[str] = None
    severity: Severity = Severity.NORMAL
    
    # 详细结果
    detection_results: List[DetectionResult] = field(default_factory=list)
    suppressed_issues: List[str] = field(default_factory=list)
    independent_issues: List[str] = field(default_factory=list)
    
    # 分数汇总
    scores: Dict[str, float] = field(default_factory=dict)
    
    # 元数据
    total_process_time_ms: float = 0
    detection_level: DetectionLevel = DetectionLevel.STANDARD
    config_profile: str = "normal"
    timestamp: str = ""
    
    def to_dict(self) -> Dict[str, Any]:
        """转换为字典（便于JSON序列化）"""
        return {
            "image_id": self.image_id,
            "image_path": self.image_path,
            "image_size": list(self.image_size),
            "is_abnormal": self.is_abnormal,
            "primary_issue": self.primary_issue,
            "severity": self.severity.value,
            "scores": self.scores,
            "detection_results": [
                {
                    "detector": r.detector_name,
                    "issue_type": r.issue_type,
                    "is_abnormal": r.is_abnormal,
                    "score": round(r.score, 2),
                    "threshold": r.threshold,
                    "confidence": round(r.confidence, 2),
                    "severity": r.severity.value,
                    "explanation": r.explanation,
                    "possible_causes": r.possible_causes,
                    "suggestions": r.suggestions,
                    "evidence": r.evidence
                }
                for r in self.detection_results
            ],
            "suppressed_issues": self.suppressed_issues,
            "independent_issues": self.independent_issues,
            "total_process_time_ms": round(self.total_process_time_ms, 2),
            "detection_level": self.detection_level.name,
            "config_profile": self.config_profile,
            "timestamp": self.timestamp
        }


class DiagnosisPipeline:
    """诊断流水线 - 编排检测器执行"""
    
    # 优先级抑制规则 (高优先级问题会抑制低优先级)
    SUPPRESSION_RULES = {
        "signal_loss": ["too_dark", "blur", "low_contrast", "no_texture"],
        "blue_screen": ["color_cast", "low_contrast", "low_saturation"],
        "green_screen": ["color_cast", "low_contrast", "low_saturation"],
        "snow_noise": ["blur", "noise"],
        "occlusion": ["partial_blur"],
    }
    
    def __init__(self, config: Dict[str, Any] = None):
        self.config = config or {}
        self.profile = self.config.get("profile", "normal")
        self.parallel = self.config.get("parallel", True)
        self.max_workers = self.config.get("max_workers", 4)
    
    def diagnose(
        self,
        image: np.ndarray,
        level: DetectionLevel = DetectionLevel.STANDARD,
        detectors: List[str] = None,
        image_id: str = "",
        image_path: str = ""
    ) -> DiagnosisResult:
        """
        执行完整诊断
        
        Args:
            image: BGR格式图像
            level: 检测级别
            detectors: 指定检测器列表，None表示使用该级别所有检测器
            image_id: 图像ID
            image_path: 图像路径
            
        Returns:
            DiagnosisResult: 完整诊断结果
        """
        from datetime import datetime
        start_time = time.time()
        
        # 获取检测器
        if detectors:
            detector_instances = [
                DetectorRegistry.get(name, self.config) 
                for name in detectors
            ]
            detector_instances = [d for d in detector_instances if d]
        else:
            detector_instances = DetectorRegistry.get_by_level(level, self.config)
        
        # 执行检测
        if self.parallel and len(detector_instances) > 1:
            detection_results = self._parallel_detect(
                image, detector_instances, level
            )
        else:
            detection_results = self._sequential_detect(
                image, detector_instances, level
            )
        
        # 聚合结果
        result = self._aggregate_results(
            detection_results,
            image_id=image_id,
            image_path=image_path,
            image_size=(image.shape[1], image.shape[0]),
            level=level
        )
        
        result.total_process_time_ms = (time.time() - start_time) * 1000
        result.timestamp = datetime.now().isoformat()
        result.config_profile = self.profile
        
        return result
    
    def _sequential_detect(
        self,
        image: np.ndarray,
        detectors: List,
        level: DetectionLevel
    ) -> List[DetectionResult]:
        """顺序执行检测"""
        results = []
        for detector in detectors:
            try:
                result = detector.detect(image, level)
                results.append(result)
            except Exception as e:
                # 记录错误但继续执行其他检测器
                print(f"Detector {detector.name} failed: {e}")
        return results
    
    def _parallel_detect(
        self,
        image: np.ndarray,
        detectors: List,
        level: DetectionLevel
    ) -> List[DetectionResult]:
        """并行执行检测"""
        results = []
        
        with ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = {
                executor.submit(detector.detect, image, level): detector
                for detector in detectors
            }
            
            for future in futures:
                try:
                    result = future.result(timeout=5)
                    results.append(result)
                except Exception as e:
                    detector = futures[future]
                    print(f"Detector {detector.name} failed: {e}")
        
        return results
    
    def _aggregate_results(
        self,
        detection_results: List[DetectionResult],
        image_id: str,
        image_path: str,
        image_size: tuple,
        level: DetectionLevel
    ) -> DiagnosisResult:
        """聚合检测结果，处理优先级和冲突"""
        
        # 按优先级排序（优先级数字小的在前）
        sorted_results = sorted(
            detection_results,
            key=lambda r: next(
                (d.priority for d in DetectorRegistry.get_all() 
                 if d.name == r.detector_name),
                100
            )
        )
        
        # 找出异常结果
        abnormal_results = [r for r in sorted_results if r.is_abnormal]
        
        # 应用抑制规则
        suppressed_issues = []
        active_issues = []
        
        for result in abnormal_results:
            issue = result.issue_type
            
            # 检查是否被更高优先级问题抑制
            is_suppressed = False
            for high_priority_issue in active_issues:
                if issue in self.SUPPRESSION_RULES.get(high_priority_issue, []):
                    suppressed_issues.append(issue)
                    is_suppressed = True
                    break
            
            if not is_suppressed:
                active_issues.append(issue)
        
        # 确定主要问题和严重程度
        primary_issue = active_issues[0] if active_issues else None
        
        if active_issues:
            # 找到主要问题对应的结果
            primary_result = next(
                (r for r in abnormal_results if r.issue_type == primary_issue),
                None
            )
            severity = primary_result.severity if primary_result else Severity.NORMAL
        else:
            severity = Severity.NORMAL
        
        # 汇总分数
        scores = {r.detector_name: r.score for r in sorted_results}
        
        return DiagnosisResult(
            image_id=image_id,
            image_path=image_path,
            image_size=image_size,
            is_abnormal=len(active_issues) > 0,
            primary_issue=primary_issue,
            severity=severity,
            detection_results=sorted_results,
            suppressed_issues=suppressed_issues,
            independent_issues=active_issues,
            scores=scores,
            detection_level=level
        )
```

### 3.3 配置管理设计

```python
# config/settings.py

from dataclasses import dataclass, field
from typing import Dict, Any, Optional
import yaml
import os


@dataclass
class DetectionThresholds:
    """检测阈值配置"""
    # 模糊检测
    blur_threshold: float = 100.0
    
    # 亮度检测
    brightness_min: float = 20.0
    brightness_max: float = 235.0
    
    # 对比度检测
    contrast_min: float = 30.0
    
    # 颜色检测
    saturation_min: float = 10.0  # 低于此值判定为黑白
    color_cast_threshold: float = 30.0  # 偏色阈值
    
    # 噪声检测
    noise_threshold: float = 15.0
    
    # 条纹检测
    stripe_threshold: float = 0.3


@dataclass 
class ProfileConfig:
    """配置模板"""
    name: str
    display_name: str
    description: str
    thresholds: DetectionThresholds


# 预设配置模板
PRESET_PROFILES: Dict[str, ProfileConfig] = {
    "strict": ProfileConfig(
        name="strict",
        display_name="严格模式",
        description="适用于金融、银行等对画质要求高的场景",
        thresholds=DetectionThresholds(
            blur_threshold=50.0,
            brightness_min=30.0,
            brightness_max=220.0,
            contrast_min=40.0,
            saturation_min=15.0,
            color_cast_threshold=20.0,
            noise_threshold=10.0,
            stripe_threshold=0.2
        )
    ),
    "normal": ProfileConfig(
        name="normal",
        display_name="标准模式",
        description="适用于园区、企业等一般监控场景",
        thresholds=DetectionThresholds()  # 使用默认值
    ),
    "loose": ProfileConfig(
        name="loose",
        display_name="宽松模式",
        description="适用于户外、复杂环境等场景",
        thresholds=DetectionThresholds(
            blur_threshold=150.0,
            brightness_min=10.0,
            brightness_max=245.0,
            contrast_min=20.0,
            saturation_min=5.0,
            color_cast_threshold=40.0,
            noise_threshold=25.0,
            stripe_threshold=0.4
        )
    )
}


@dataclass
class ServerConfig:
    """服务器配置"""
    host: str = "0.0.0.0"
    port: int = 8080
    workers: int = 4
    timeout: int = 30
    max_request_size: int = 50 * 1024 * 1024  # 50MB


@dataclass
class StorageConfig:
    """存储配置"""
    result_dir: str = "./results"
    sample_dir: str = "./samples"
    keep_days: int = 30
    save_thumbnails: bool = True
    thumbnail_size: tuple = (320, 240)


@dataclass
class LogConfig:
    """日志配置"""
    level: str = "INFO"
    format: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    file: Optional[str] = None
    max_size: int = 10 * 1024 * 1024  # 10MB
    backup_count: int = 5


@dataclass
class SampleCollectionConfig:
    """样本收集配置"""
    enabled: bool = True
    collect_abnormal: bool = True
    collect_boundary: bool = True  # 收集置信度边界样本
    boundary_range: tuple = (0.3, 0.7)  # 置信度在此区间的为边界样本
    max_samples_per_type: int = 1000


@dataclass
class AppConfig:
    """应用总配置"""
    # 检测配置
    profile: str = "normal"
    detection_level: str = "standard"
    parallel_detection: bool = True
    max_workers: int = 4
    gpu_enabled: bool = False
    
    # 自定义阈值（覆盖profile中的阈值）
    custom_thresholds: Optional[Dict[str, float]] = None
    
    # 子配置
    server: ServerConfig = field(default_factory=ServerConfig)
    storage: StorageConfig = field(default_factory=StorageConfig)
    log: LogConfig = field(default_factory=LogConfig)
    sample_collection: SampleCollectionConfig = field(default_factory=SampleCollectionConfig)
    
    def get_thresholds(self) -> DetectionThresholds:
        """获取最终阈值配置"""
        # 先获取profile的阈值
        profile = PRESET_PROFILES.get(self.profile, PRESET_PROFILES["normal"])
        thresholds = profile.thresholds
        
        # 应用自定义阈值覆盖
        if self.custom_thresholds:
            for key, value in self.custom_thresholds.items():
                if hasattr(thresholds, key):
                    setattr(thresholds, key, value)
        
        return thresholds
    
    @classmethod
    def load(cls, config_path: str = None) -> "AppConfig":
        """从文件加载配置"""
        if config_path and os.path.exists(config_path):
            with open(config_path, 'r', encoding='utf-8') as f:
                data = yaml.safe_load(f)
            return cls._from_dict(data)
        return cls()
    
    @classmethod
    def _from_dict(cls, data: Dict[str, Any]) -> "AppConfig":
        """从字典创建配置"""
        config = cls()
        
        for key, value in data.items():
            if key == "server" and isinstance(value, dict):
                config.server = ServerConfig(**value)
            elif key == "storage" and isinstance(value, dict):
                config.storage = StorageConfig(**value)
            elif key == "log" and isinstance(value, dict):
                config.log = LogConfig(**value)
            elif key == "sample_collection" and isinstance(value, dict):
                config.sample_collection = SampleCollectionConfig(**value)
            elif hasattr(config, key):
                setattr(config, key, value)
        
        return config
    
    def to_dict(self) -> Dict[str, Any]:
        """导出为字典"""
        return {
            "profile": self.profile,
            "detection_level": self.detection_level,
            "parallel_detection": self.parallel_detection,
            "max_workers": self.max_workers,
            "gpu_enabled": self.gpu_enabled,
            "custom_thresholds": self.custom_thresholds,
            "server": {
                "host": self.server.host,
                "port": self.server.port,
                "workers": self.server.workers,
                "timeout": self.server.timeout
            },
            "storage": {
                "result_dir": self.storage.result_dir,
                "sample_dir": self.storage.sample_dir,
                "keep_days": self.storage.keep_days
            },
            "log": {
                "level": self.log.level,
                "file": self.log.file
            },
            "sample_collection": {
                "enabled": self.sample_collection.enabled,
                "collect_abnormal": self.sample_collection.collect_abnormal
            }
        }
```

### 3.4 配置文件示例

```yaml
# config.yaml - 配置文件示例

# 检测配置
profile: normal                    # 配置模板: strict/normal/loose
detection_level: standard          # 检测级别: fast/standard/deep
parallel_detection: true           # 是否并行检测
max_workers: 4                     # 最大并发数
gpu_enabled: false                 # 是否启用GPU

# 自定义阈值（可选，会覆盖profile中的配置）
custom_thresholds:
  blur_threshold: 120
  brightness_min: 25

# 服务器配置
server:
  host: 0.0.0.0
  port: 8080
  workers: 4
  timeout: 30

# 存储配置  
storage:
  result_dir: ./results            # 结果存储目录
  sample_dir: ./samples            # 样本存储目录
  keep_days: 30                    # 结果保留天数
  save_thumbnails: true            # 是否保存缩略图
  thumbnail_size: [320, 240]

# 日志配置
log:
  level: INFO                      # DEBUG/INFO/WARNING/ERROR
  file: ./logs/originx.log         # 日志文件路径（可选）

# 样本收集配置
sample_collection:
  enabled: true                    # 是否启用样本收集
  collect_abnormal: true           # 收集异常样本
  collect_boundary: true           # 收集边界样本
  boundary_range: [0.3, 0.7]       # 边界置信度区间
  max_samples_per_type: 1000       # 每类最大样本数
```

## 四、API 接口设计

### 4.1 RESTful API 设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API 接口设计                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   基础路径: /api/v1                                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         诊断接口                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  POST /diagnose/image          单图诊断（同步）                      │   │
│   │  POST /diagnose/image/async    单图诊断（异步）                      │   │
│   │  POST /diagnose/batch          批量诊断                              │   │
│   │  POST /diagnose/video          视频文件诊断                          │   │
│   │  GET  /diagnose/task/{task_id} 查询异步任务状态                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         配置接口                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  GET  /config                  获取当前配置                          │   │
│   │  PUT  /config                  更新配置                              │   │
│   │  GET  /config/profiles         获取所有配置模板                      │   │
│   │  GET  /config/profiles/{name}  获取指定配置模板                      │   │
│   │  GET  /config/thresholds       获取当前阈值                          │   │
│   │  PUT  /config/thresholds       更新阈值                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         检测器接口                                   │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  GET  /detectors               获取所有检测器列表                    │   │
│   │  GET  /detectors/{name}        获取检测器详情                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         报告接口                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  GET  /reports/{task_id}       获取诊断报告                          │   │
│   │  GET  /reports/{task_id}/html  获取HTML格式报告                      │   │
│   │  GET  /reports/{task_id}/json  获取JSON格式报告                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         系统接口                                     │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  GET  /health                  健康检查                              │   │
│   │  GET  /info                    系统信息                              │   │
│   │  GET  /metrics                 性能指标                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 核心接口定义

#### 4.2.1 单图诊断接口

```yaml
POST /api/v1/diagnose/image

# 请求
Content-Type: multipart/form-data 或 application/json

# Form-data 方式
file: <binary>                      # 图片文件

# JSON 方式
{
  "image": "<base64_string>",       # Base64编码的图片
  "image_url": "http://...",        # 或图片URL
  
  # 可选参数
  "profile": "normal",              # 配置模板
  "level": "standard",              # 检测级别
  "detectors": ["blur", "brightness"], # 指定检测器（可选）
  "return_evidence": true,          # 是否返回证据数据
  "save_sample": false              # 是否保存样本
}

# 响应
{
  "code": 0,
  "message": "success",
  "data": {
    "task_id": "img_20240101_123456_abc123",
    "is_abnormal": true,
    "primary_issue": "blur",
    "severity": "warning",
    "scores": {
      "blur": 45.2,
      "brightness": 128.5,
      "contrast": 65.3,
      "color": 85.0,
      "noise": 12.3
    },
    "issues": [
      {
        "type": "blur",
        "is_abnormal": true,
        "score": 45.2,
        "threshold": 100,
        "confidence": 0.87,
        "severity": "warning",
        "explanation": "图像清晰度评分45.2，低于阈值100，判定为模糊",
        "possible_causes": [
          "镜头脏污或有水渍",
          "摄像头对焦不准确"
        ],
        "suggestions": [
          "检查并清洁摄像头镜头",
          "调整摄像头对焦设置"
        ],
        "evidence": {
          "laplacian_variance": 45.2,
          "gradient_mean": 38.7,
          "edge_density": 0.12
        }
      }
    ],
    "suppressed_issues": [],
    "image_info": {
      "width": 1920,
      "height": 1080,
      "format": "JPEG"
    }
  },
  "meta": {
    "process_time_ms": 45,
    "detection_level": "standard",
    "profile": "normal",
    "version": "1.0.0",
    "timestamp": "2024-01-01T12:34:56.789Z"
  }
}
```

#### 4.2.2 批量诊断接口

```yaml
POST /api/v1/diagnose/batch

# 请求
{
  "images": [
    {"id": "img_001", "url": "http://..."},
    {"id": "img_002", "base64": "..."},
    {"id": "img_003", "path": "/path/to/image.jpg"}
  ],
  "profile": "normal",
  "level": "fast",
  "callback_url": "http://your-server/callback"  # 可选，完成后回调
}

# 响应（立即返回任务ID）
{
  "code": 0,
  "message": "success",
  "data": {
    "task_id": "batch_20240101_123456_abc123",
    "total_images": 3,
    "status": "processing",
    "estimated_time_seconds": 5
  }
}

# 查询任务状态
GET /api/v1/diagnose/task/{task_id}

{
  "code": 0,
  "data": {
    "task_id": "batch_20240101_123456_abc123",
    "status": "completed",  # pending/processing/completed/failed
    "progress": {
      "total": 3,
      "processed": 3,
      "abnormal": 1
    },
    "results": [
      {...},  # 同单图诊断结果
      {...},
      {...}
    ],
    "summary": {
      "total_images": 3,
      "abnormal_count": 1,
      "normal_count": 2,
      "issue_distribution": {
        "blur": 1
      }
    }
  }
}
```

### 4.3 错误码设计

```python
# 错误码定义
ERROR_CODES = {
    # 成功
    0: "success",
    
    # 客户端错误 4xxxx
    40001: "Invalid image format",
    40002: "Image size exceeds limit",
    40003: "Invalid parameter",
    40004: "Missing required parameter",
    40005: "Invalid profile name",
    40006: "Invalid detection level",
    40007: "Image decode failed",
    40008: "URL fetch failed",
    
    # 服务端错误 5xxxx
    50001: "Internal server error",
    50002: "Detection failed",
    50003: "Storage error",
    50004: "Configuration error",
    50005: "Service unavailable",
    50006: "Timeout",
}
```

## 五、CLI 命令设计

```bash
# CLI 命令结构
originx <command> <subcommand> [options]

# ==================== 诊断命令 ====================

# 单图诊断
originx detect image <path> [options]
  --profile, -p      配置模板 (strict/normal/loose)
  --level, -l        检测级别 (fast/standard/deep)
  --output, -o       输出文件路径
  --format, -f       输出格式 (json/table/simple)
  --detectors, -d    指定检测器 (逗号分隔)
  --verbose, -v      详细输出

# 示例
originx detect image ./test.jpg
originx detect image ./test.jpg -p strict -l deep -f json
originx detect image ./test.jpg -d blur,brightness -o result.json

# 批量诊断
originx detect batch <directory> [options]
  --pattern          文件匹配模式 (默认: *.jpg,*.png)
  --recursive, -r    递归子目录
  --output, -o       输出目录
  --report           生成汇总报告

# 示例
originx detect batch ./images/ -r -o ./results/ --report

# 视频诊断
originx detect video <path> [options]
  --sample-rate      采样率 (每秒帧数)
  --start-time       开始时间 (秒)
  --duration         持续时间 (秒)

# 示例
originx detect video ./test.mp4 --sample-rate 1


# ==================== 服务命令 ====================

# 启动API服务
originx serve [options]
  --host             监听地址 (默认: 0.0.0.0)
  --port, -p         端口 (默认: 8080)
  --workers, -w      工作进程数 (默认: 4)
  --config, -c       配置文件路径
  --reload           开发模式,自动重载

# 示例
originx serve -p 8080 -w 4 -c config.yaml


# ==================== 配置命令 ====================

# 查看配置
originx config show [--profile <name>]

# 验证配置文件
originx config validate <config_path>

# 生成默认配置
originx config init [--output <path>]

# 列出所有配置模板
originx config profiles


# ==================== 工具命令 ====================

# 性能基准测试
originx benchmark [options]
  --images           测试图片目录
  --count, -n        测试次数 (默认: 100)
  --level            检测级别

# 示例
originx benchmark --images ./test_set/ -n 1000

# 检测器信息
originx detectors list
originx detectors info <name>

# 系统信息
originx info


# ==================== 样本管理 ====================

# 查看样本统计
originx samples stats

# 导出样本
originx samples export <output_dir> [--type <type>]

# 清理样本
originx samples clean [--keep-days <days>]
```

## 六、项目目录结构

```
originx/
├── README.md                       # 项目说明
├── LICENSE
├── setup.py                        # 安装脚本
├── pyproject.toml
├── requirements.txt                # 依赖
├── requirements-dev.txt            # 开发依赖
├── Dockerfile                      # Docker构建
├── docker-compose.yml
├── Makefile                        # 常用命令
│
├── config/                         # 配置模块
│   ├── __init__.py
│   ├── settings.py                 # 配置定义
│   ├── profiles.py                 # 配置模板
│   └── default.yaml                # 默认配置文件
│
├── core/                           # 核心算法模块
│   ├── __init__.py
│   ├── base.py                     # 基类定义
│   ├── registry.py                 # 检测器注册表
│   ├── pipeline.py                 # 检测流水线
│   │
│   ├── detectors/                  # 检测器实现
│   │   ├── __init__.py
│   │   ├── blur_detector.py        # 模糊检测
│   │   ├── brightness_detector.py  # 亮度检测
│   │   ├── contrast_detector.py    # 对比度检测
│   │   ├── color_detector.py       # 颜色检测
│   │   ├── noise_detector.py       # 噪声检测
│   │   ├── stripe_detector.py      # 条纹检测
│   │   ├── occlusion_detector.py   # 遮挡检测
│   │   └── signal_loss_detector.py # 信号丢失
│   │
│   ├── video/                      # 视频分析
│   │   ├── __init__.py
│   │   ├── frame_extractor.py      # 帧提取
│   │   ├── freeze_detector.py      # 冻结检测
│   │   └── video_pipeline.py       # 视频流水线
│   │
│   └── utils/                      # 核心工具
│       ├── __init__.py
│       ├── image_utils.py          # 图像处理工具
│       └── metrics.py              # 指标计算
│
├── api/                            # API服务模块
│   ├── __init__.py
│   ├── main.py                     # FastAPI入口
│   ├── routes/                     # 路由
│   │   ├── __init__.py
│   │   ├── diagnose.py             # 诊断接口
│   │   ├── config.py               # 配置接口
│   │   ├── detectors.py            # 检测器接口
│   │   └── system.py               # 系统接口
│   ├── schemas/                    # Pydantic模型
│   │   ├── __init__.py
│   │   ├── request.py              # 请求模型
│   │   └── response.py             # 响应模型
│   ├── middleware/                 # 中间件
│   │   ├── __init__.py
│   │   └── error_handler.py
│   └── dependencies.py             # 依赖注入
│
├── cli/                            # CLI模块
│   ├── __init__.py
│   ├── main.py                     # CLI入口
│   ├── commands/                   # 命令实现
│   │   ├── __init__.py
│   │   ├── detect.py               # 诊断命令
│   │   ├── serve.py                # 服务命令
│   │   ├── config.py               # 配置命令
│   │   └── benchmark.py            # 基准测试
│   └── utils/                      # CLI工具
│       ├── __init__.py
│       └── output.py               # 输出格式化
│
├── services/                       # 业务服务层
│   ├── __init__.py
│   ├── diagnosis_service.py        # 诊断服务
│   ├── report_service.py           # 报告服务
│   └── sample_service.py           # 样本服务
│
├── storage/                        # 存储模块
│   ├── __init__.py
│   ├── base.py                     # 存储基类
│   ├── file_storage.py             # 文件存储
│   └── sample_storage.py           # 样本存储
│
├── utils/                          # 通用工具
│   ├── __init__.py
│   ├── logger.py                   # 日志工具
│   ├── image_loader.py             # 图像加载
│   └── validators.py               # 验证器
│
├── tests/                          # 测试
│   ├── __init__.py
│   ├── conftest.py                 # pytest配置
│   ├── test_data/                  # 测试数据
│   │   ├── normal/                 # 正常样本
│   │   └── abnormal/               # 异常样本
│   ├── unit/                       # 单元测试
│   │   ├── test_blur_detector.py
│   │   ├── test_brightness_detector.py
│   │   └── ...
│   ├── integration/                # 集成测试
│   │   ├── test_pipeline.py
│   │   └── test_api.py
│   └── benchmark/                  # 性能测试
│       └── test_performance.py
│
├── doc/                            # 文档
│   ├── 01-系统设计方案.md
│   ├── 02-技术选型分析.md
│   ├── 03-产品规划与改进建议.md
│   ├── 04-单机版系统设计.md
│   └── api/                        # API文档
│       └── openapi.yaml
│
└── scripts/                        # 脚本
    ├── install.sh                  # 安装脚本
    ├── build_docker.sh             # Docker构建
    └── generate_test_data.py       # 生成测试数据
```

## 七、开发计划

### 7.1 里程碑规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            开发里程碑                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   M1: 核心框架 (1周)                                                        │
│   ├── 项目初始化、目录结构                                                   │
│   ├── 配置管理模块                                                          │
│   ├── 检测器基类和注册表                                                     │
│   ├── 检测流水线框架                                                         │
│   └── 基础工具函数                                                          │
│                                                                             │
│   M2: 核心检测器 (2周)                                                      │
│   ├── 模糊检测器                                                            │
│   ├── 亮度检测器                                                            │
│   ├── 对比度检测器                                                          │
│   ├── 颜色检测器                                                            │
│   ├── 噪声检测器                                                            │
│   └── 单元测试                                                              │
│                                                                             │
│   M3: API服务 (1周)                                                         │
│   ├── FastAPI框架搭建                                                       │
│   ├── 诊断接口实现                                                          │
│   ├── 配置接口实现                                                          │
│   ├── 错误处理                                                              │
│   └── API文档                                                               │
│                                                                             │
│   M4: CLI工具 (1周)                                                         │
│   ├── CLI框架搭建                                                           │
│   ├── 诊断命令                                                              │
│   ├── 服务命令                                                              │
│   ├── 配置命令                                                              │
│   └── 基准测试命令                                                          │
│                                                                             │
│   M5: 扩展检测器 (1周)                                                      │
│   ├── 条纹检测器                                                            │
│   ├── 遮挡检测器                                                            │
│   ├── 信号丢失检测器                                                        │
│   └── 视频帧提取                                                            │
│                                                                             │
│   M6: 完善与发布 (1周)                                                      │
│   ├── 报告生成                                                              │
│   ├── 样本收集                                                              │
│   ├── Docker打包                                                            │
│   ├── 文档完善                                                              │
│   └── 发布准备                                                              │
│                                                                             │
│   总计: 7周                                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 技术依赖

```
# requirements.txt

# 核心依赖
numpy>=1.21.0
opencv-python>=4.5.0
Pillow>=9.0.0
scipy>=1.7.0

# API框架
fastapi>=0.100.0
uvicorn>=0.22.0
python-multipart>=0.0.6
pydantic>=2.0.0

# CLI
click>=8.0.0
rich>=13.0.0          # 美化输出

# 配置
pyyaml>=6.0
python-dotenv>=1.0.0

# 工具
requests>=2.28.0
aiofiles>=23.0.0
httpx>=0.24.0         # 异步HTTP

# 可选: GPU加速
# opencv-python-headless  # 无GUI版本
# cupy                    # GPU数组
```

## 八、质量保证

### 8.1 测试策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            测试策略                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   单元测试 (Unit Tests)                                                     │
│   ├── 每个检测器的核心算法                                                   │
│   ├── 配置加载和验证                                                         │
│   ├── 工具函数                                                              │
│   └── 覆盖率目标: > 80%                                                     │
│                                                                             │
│   集成测试 (Integration Tests)                                              │
│   ├── 完整诊断流水线                                                         │
│   ├── API端到端测试                                                          │
│   ├── CLI命令测试                                                            │
│   └── 配置模板测试                                                          │
│                                                                             │
│   性能测试 (Performance Tests)                                              │
│   ├── 单图处理延迟                                                          │
│   ├── 批量处理吞吐量                                                         │
│   ├── 内存占用                                                              │
│   └── 并发能力                                                              │
│                                                                             │
│   准确性测试 (Accuracy Tests)                                               │
│   ├── 标准测试集验证                                                         │
│   ├── 各指标准确率/召回率                                                    │
│   └── 误报率统计                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 标准测试集

```
test_data/
├── normal/                    # 正常样本 (1000张)
│   ├── indoor/               # 室内场景
│   ├── outdoor/              # 户外场景
│   ├── night/                # 夜间场景
│   └── various/              # 其他场景
│
├── blur/                      # 模糊样本 (200张)
│   ├── motion_blur/          # 运动模糊
│   ├── focus_blur/           # 对焦模糊
│   └── lens_blur/            # 镜头模糊
│
├── brightness/                # 亮度异常 (200张)
│   ├── too_dark/             # 过暗
│   └── too_bright/           # 过亮
│
├── color/                     # 颜色异常 (200张)
│   ├── color_cast/           # 偏色
│   ├── grayscale/            # 黑白
│   ├── blue_screen/          # 蓝屏
│   └── green_screen/         # 绿屏
│
├── noise/                     # 噪声样本 (200张)
│   ├── gaussian_noise/       # 高斯噪声
│   ├── salt_pepper/          # 椒盐噪声
│   └── snow/                 # 雪花噪声
│
├── stripe/                    # 条纹干扰 (100张)
│
├── occlusion/                 # 遮挡样本 (100张)
│
└── signal_loss/               # 信号丢失 (100张)
    ├── black_screen/         # 黑屏
    └── no_signal/            # 无信号
```

## 九、部署方案

### 9.1 Docker 部署

```dockerfile
# Dockerfile

FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY . .

# 安装包
RUN pip install -e .

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["originx", "serve", "--host", "0.0.0.0", "--port", "8080"]
```

```yaml
# docker-compose.yml

version: '3.8'

services:
  originx:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
      - ./results:/app/results
      - ./samples:/app/samples
    environment:
      - ORIGINX_CONFIG=/app/config.yaml
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 9.2 快速启动

```bash
# 方式一: Docker (推荐)
docker run -p 8080:8080 originx/video-diagnosis:latest

# 方式二: pip安装
pip install originx
originx serve

# 方式三: 源码运行
git clone https://github.com/xxx/originx.git
cd originx
pip install -r requirements.txt
pip install -e .
originx serve
```

## 十、总结

本设计文档定义了单机版图像/视频质量诊断系统的完整架构，核心特点：

1. **插件化检测器架构** - 便于扩展新检测器
2. **分级检测策略** - 平衡性能和准确性
3. **可配置阈值** - 适应不同场景
4. **结果可解释性** - 提供原因和建议
5. **多指标冲突处理** - 优先级抑制机制
6. **样本收集机制** - 为后续优化铺垫

建议按照里程碑规划逐步实现，优先完成核心检测器和API服务，确保MVP可用后再扩展功能。

