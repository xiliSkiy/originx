# OriginX 用户指南

> 详细的使用教程和最佳实践

## 目录

- [快速开始](#快速开始)
- [安装部署](#安装部署)
- [CLI 使用](#cli-使用)
- [API 使用](#api-使用)
- [Web UI 使用](#web-ui-使用)
- [配置说明](#配置说明)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)
- [故障排查](#故障排查)

---

## 快速开始

### 5 分钟快速体验

```bash
# 1. 安装
pip install -r requirements.txt
pip install -e .

# 2. 验证安装
originx info

# 3. 检测单张图片
originx detect image ./test.jpg

# 4. 启动 API 服务
originx serve -p 8080

# 5. 访问 Web UI
# 浏览器打开 http://localhost:8080 (如果已部署前端)
```

---

## 安装部署

### 系统要求

- **操作系统**: Linux / macOS / Windows
- **Python**: 3.9+
- **内存**: 最低 2GB，推荐 4GB+
- **磁盘**: 最低 1GB 可用空间

### 方式一：pip 安装

```bash
# 克隆项目
git clone https://github.com/xxx/originx.git
cd originx

# 安装依赖
pip install -r requirements.txt

# 安装包
pip install -e .

# 验证安装
originx info
```

### 方式二：Docker 安装

```bash
# 构建镜像
docker build -t originx:latest .

# 运行容器
docker run -d \
  --name originx \
  -p 8080:8080 \
  -v /data/images:/data/images \
  -v /data/reports:/data/reports \
  originx:latest

# 查看日志
docker logs -f originx
```

### 方式三：Docker Compose

```bash
# 启动服务
docker-compose up -d

# 查看状态
docker-compose ps

# 停止服务
docker-compose down
```

---

## CLI 使用

### 图像检测

#### 单图检测

```bash
# 基本用法
originx detect image ./test.jpg

# 指定配置模板
originx detect image ./test.jpg -p strict

# 指定检测级别
originx detect image ./test.jpg -l deep

# 指定检测器
originx detect image ./test.jpg --detectors blur,brightness

# 输出 JSON 格式
originx detect image ./test.jpg -f json -o result.json

# 输出详细信息
originx detect image ./test.jpg -v
```

#### 批量检测

```bash
# 检测目录下所有图片
originx detect batch ./images/

# 递归检测子目录
originx detect batch ./images/ -r

# 指定文件模式
originx detect batch ./images/ --pattern "*.jpg"

# 生成报告
originx detect batch ./images/ --report -o ./results/

# 指定配置
originx detect batch ./images/ -p strict -l standard
```

### 视频检测（V1.5 新增）

#### 单视频检测

```bash
# 基本用法
originx video detect ./test.mp4

# 指定采样策略
originx video detect ./test.mp4 --sample-strategy scene_change

# 指定采样间隔
originx video detect ./test.mp4 --sample-interval 2.0

# 限制最大帧数
originx video detect ./test.mp4 --max-frames 100

# 指定检测器
originx video detect ./test.mp4 --detectors freeze,shake
```

#### 批量视频检测

```bash
# 检测目录下所有视频
originx video batch ./videos/

# 指定文件模式
originx video batch ./videos/ --pattern "*.mp4"

# 生成报告
originx video batch ./videos/ --report -o ./results/
```

### 定时任务管理（V1.5 新增）

#### 创建任务

```bash
# 创建批量检测任务
originx task create \
  -n "每日巡检" \
  -t batch \
  -c "0 2 * * *" \
  -i /data/images \
  --pattern "*.jpg" \
  -p normal

# 创建抽样检测任务
originx task create \
  -n "高峰期抽检" \
  -t sample \
  -c "0 9,12,18 * * 1-5" \
  --sample-rate 0.1 \
  -i /data/images

# 创建视频检测任务
originx task create \
  -n "视频巡检" \
  -t video \
  -c "0 3 * * *" \
  -i /data/videos
```

#### 任务管理

```bash
# 查看任务列表
originx task list

# 查看任务详情
originx task show <task_id>

# 启用任务
originx task enable <task_id>

# 禁用任务
originx task disable <task_id>

# 立即执行任务
originx task run <task_id>

# 删除任务
originx task delete <task_id>

# 查看执行历史
originx task executions <task_id>
```

### 报告导出（V1.5 新增）

```bash
# 导出 Excel 报告
originx report export result.json -f excel -o report.xlsx

# 导出 PDF 报告
originx report export result.json -f pdf -o report.pdf

# 导出 HTML 报告
originx report export result.json -f html -o report.html

# 导出多种格式
originx report export result.json -f excel -f pdf -f html
```

### 配置管理

```bash
# 查看当前配置
originx config show

# 查看配置模板
originx config profiles

# 设置配置模板
originx config set-profile strict

# 设置检测级别
originx config set-level deep

# 更新阈值
originx config set-threshold blur_threshold 0.6
```

### 系统信息

```bash
# 查看系统信息
originx info

# 查看检测器列表
originx detectors

# 查看检测器详情
originx detectors show blur

# 性能基准测试
originx benchmark -n 1000
```

---

## API 使用

### 启动服务

```bash
# 基本启动
originx serve

# 指定端口
originx serve -p 8080

# 指定工作进程数
originx serve -w 4

# 后台运行
originx serve -d
```

### 图像诊断 API

#### Python 示例

```python
import requests

# 单图诊断
files = {'file': open('test.jpg', 'rb')}
data = {
    'profile': 'normal',
    'level': 'standard'
}
response = requests.post(
    'http://localhost:8080/api/v1/diagnose/image',
    files=files,
    data=data
)
result = response.json()
print(result)

# 批量诊断
batch_data = {
    'image_paths': [
        '/path/to/image1.jpg',
        '/path/to/image2.jpg'
    ],
    'profile': 'normal',
    'level': 'standard',
    'generate_report': True
}
response = requests.post(
    'http://localhost:8080/api/v1/diagnose/batch',
    json=batch_data
)
result = response.json()
print(result)
```

#### cURL 示例

```bash
# 单图诊断
curl -X POST http://localhost:8080/api/v1/diagnose/image \
  -F "file=@test.jpg" \
  -F "profile=normal" \
  -F "level=standard"

# 批量诊断
curl -X POST http://localhost:8080/api/v1/diagnose/batch \
  -H "Content-Type: application/json" \
  -d '{
    "image_paths": ["/path/to/image1.jpg"],
    "profile": "normal"
  }'
```

### 视频诊断 API

```python
import requests

# 视频诊断
files = {'video': open('test.mp4', 'rb')}
data = {
    'profile': 'normal',
    'sample_interval': 1.0,
    'max_frames': 300
}
response = requests.post(
    'http://localhost:8080/api/v1/video/diagnose',
    files=files,
    data=data
)
result = response.json()
print(result)
```

### 任务管理 API

```python
import requests

# 创建任务
task_data = {
    'name': '每日巡检',
    'task_type': 'batch',
    'cron_expression': '0 2 * * *',
    'enabled': True,
    'config': {
        'input_path': '/data/images',
        'pattern': '*.jpg'
    }
}
response = requests.post(
    'http://localhost:8080/api/v1/tasks',
    json=task_data
)
result = response.json()
print(result)

# 获取任务列表
response = requests.get('http://localhost:8080/api/v1/tasks')
tasks = response.json()
print(tasks)

# 立即执行任务
response = requests.post(
    f'http://localhost:8080/api/v1/tasks/{task_id}/run'
)
print(response.json())
```

详细 API 文档请参考 [API文档.md](./API文档.md)

---

## Web UI 使用

### 启动 Web UI

```bash
# 1. 启动后端服务
originx serve -p 8080

# 2. 启动前端（新终端）
cd web
npm install
npm run dev

# 3. 访问
# 浏览器打开 http://localhost:5173
```

### 功能说明

#### 仪表盘

- **系统概览**: 显示总体健康度、异常统计
- **趋势图表**: 异常趋势、检测量统计
- **最近记录**: 最近检测记录列表

#### 检测中心

- **单图检测**: 上传图片进行检测
- **批量检测**: 上传多张图片批量检测
- **视频检测**: 上传视频文件进行检测
- **结果查看**: 查看检测结果详情

#### 任务管理

- **任务列表**: 查看所有定时任务
- **创建任务**: 配置新的定时任务
- **执行历史**: 查看任务执行记录
- **任务控制**: 启用/禁用/删除任务

#### 系统设置

- **阈值配置**: 调整检测阈值
- **检测器管理**: 启用/禁用检测器
- **配置模板**: 选择配置模板
- **系统参数**: 调整系统参数

---

## 配置说明

### 配置模板

| 模板 | 说明 | 适用场景 |
|------|------|---------|
| `strict` | 严格模式 | 金融、银行等高要求场景 |
| `normal` | 标准模式 | 园区、企业等一般场景 |
| `loose` | 宽松模式 | 户外、复杂环境 |

### 检测级别

| 级别 | 说明 | 耗时 | 适用场景 |
|------|------|------|---------|
| `fast` | 快速筛查 | < 5ms | 大批量快速筛查 |
| `standard` | 标准检测 | < 20ms | 日常检测 |
| `deep` | 深度分析 | < 100ms | 高精度检测 |

### 配置文件

创建 `config.yaml`:

```yaml
# 基础配置
profile: normal
detection_level: standard
parallel_detection: true
max_workers: 4

# 自定义阈值
custom_thresholds:
  blur_threshold: 0.5
  brightness_min: 25
  brightness_max: 230
  contrast_min: 0.3
  saturation_min: 0.2
  color_cast_threshold: 0.15
  noise_threshold: 0.1
  stripe_threshold: 0.05

# 服务器配置
server:
  host: 0.0.0.0
  port: 8080
  workers: 4
  max_upload_size: 104857600  # 100MB

# 日志配置
logging:
  level: INFO
  file: logs/originx.log
```

使用配置文件:

```bash
originx serve --config config.yaml
```

---

## 最佳实践

### 1. 性能优化

#### 批量检测优化

```bash
# 使用 fast 级别进行快速筛查
originx detect batch ./images/ -l fast

# 只对异常图片进行深度分析
# 先快速筛查，再对异常图片深度检测
```

#### 并发控制

```bash
# 根据 CPU 核心数设置工作进程
originx serve -w $(nproc)
```

### 2. 定时任务配置

#### Cron 表达式最佳实践

```bash
# 每天凌晨2点（低峰期）
0 2 * * *

# 每6小时检测一次
0 */6 * * *

# 工作日高峰期（9点、12点、18点）
0 9,12,18 * * 1-5

# 每小时检测一次
0 * * * *
```

#### 任务分组

- **高频任务**: 使用 fast 级别，快速筛查
- **深度任务**: 使用 deep 级别，定期深度分析
- **抽样任务**: 使用 sample 模式，降低负载

### 3. 阈值调优

#### 调优流程

1. **收集样本**: 收集正常和异常样本各 100+ 张
2. **基准测试**: 使用默认阈值进行检测
3. **分析结果**: 统计误报率和漏报率
4. **调整阈值**: 根据统计结果调整阈值
5. **验证效果**: 使用新阈值重新测试

#### 阈值调整建议

- **误报率高**: 提高阈值（更宽松）
- **漏报率高**: 降低阈值（更严格）
- **场景变化**: 针对不同场景使用不同配置模板

### 4. 报告管理

#### 报告存储

```bash
# 使用时间戳命名
originx detect batch ./images/ -o "./reports/$(date +%Y%m%d_%H%M%S)"

# 定期清理旧报告
find ./reports -name "*.json" -mtime +30 -delete
```

#### 报告格式选择

- **JSON**: 程序处理、数据分析
- **HTML**: 人工查看、可视化展示
- **Excel**: 统计分析、数据导出
- **PDF**: 正式报告、归档保存

### 5. 错误处理

#### API 错误处理

```python
import requests

try:
    response = requests.post(
        'http://localhost:8080/api/v1/diagnose/image',
        files={'file': open('test.jpg', 'rb')},
        timeout=30
    )
    response.raise_for_status()
    result = response.json()
except requests.exceptions.Timeout:
    print("请求超时")
except requests.exceptions.HTTPError as e:
    print(f"HTTP 错误: {e}")
except Exception as e:
    print(f"其他错误: {e}")
```

---

## 常见问题

### Q1: 检测结果不准确怎么办？

**A**: 
1. 检查图像质量（分辨率、格式）
2. 尝试不同的配置模板（strict/normal/loose）
3. 调整检测级别（fast/standard/deep）
4. 根据场景调优阈值

### Q2: 视频检测很慢怎么办？

**A**:
1. 增加采样间隔（`--sample-interval 2.0`）
2. 限制最大帧数（`--max-frames 100`）
3. 使用场景变化采样策略（`--sample-strategy scene_change`）
4. 只启用必要的检测器

### Q3: 定时任务不执行？

**A**:
1. 检查任务是否启用（`originx task list`）
2. 检查 Cron 表达式是否正确
3. 查看任务执行历史（`originx task executions <task_id>`）
4. 检查日志文件

### Q4: 内存占用过高？

**A**:
1. 减少并发数（`-w 2`）
2. 使用 fast 级别检测
3. 批量检测时减少批次大小
4. 定期清理临时文件

### Q5: API 服务无法启动？

**A**:
1. 检查端口是否被占用（`lsof -i :8080`）
2. 检查配置文件是否正确
3. 查看日志文件（`logs/originx.log`）
4. 检查依赖是否安装完整

---

## 故障排查

### 日志查看

```bash
# 查看服务日志
tail -f logs/originx.log

# 查看错误日志
grep ERROR logs/originx.log

# 查看 Docker 日志
docker logs -f originx
```

### 性能分析

```bash
# 运行基准测试
originx benchmark -n 1000

# 查看系统资源
originx info

# 监控 API 性能
# 使用 Swagger UI 的测试功能
```

### 常见错误

#### ImportError

```bash
# 重新安装依赖
pip install -r requirements.txt --force-reinstall
```

#### 端口占用

```bash
# 查找占用进程
lsof -i :8080

# 杀死进程
kill -9 <PID>

# 或使用其他端口
originx serve -p 8081
```

#### 权限错误

```bash
# 检查文件权限
ls -l /data/images

# 修改权限
chmod -R 755 /data/images
```

---

## 获取帮助

- **文档**: 查看 [README.md](../README.md) 和 [API文档.md](./API文档.md)
- **问题反馈**: 提交 [GitHub Issue](https://github.com/xxx/originx/issues)
- **社区支持**: 加入社区讨论

---

*最后更新: 2026-01-XX*
