# 图像/视频质量诊断系统 - 系统设计方案

## 一、系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           图像/视频质量诊断系统                            │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Web 前端   │  │  REST API   │  │  WebSocket  │  │  管理后台   │    │
│  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘  └─────┬───────┘    │
│        │                │                │                │            │
│        └────────────────┼────────────────┼────────────────┘            │
│                         ▼                ▼                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        API Gateway / 服务层                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                   │
│        ┌───────────────────────────┼───────────────────────────┐       │
│        ▼                           ▼                           ▼       │
│  ┌───────────┐             ┌───────────┐             ┌───────────┐     │
│  │ 图像诊断  │             │ 视频诊断  │             │ 流媒体    │     │
│  │ 引擎      │             │ 引擎      │             │ 分析引擎  │     │
│  └─────┬─────┘             └─────┬─────┘             └─────┬─────┘     │
│        │                         │                         │           │
│        └─────────────────────────┼─────────────────────────┘           │
│                                  ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      核心算法层 (Core Engine)                     │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │模糊检测 │ │颜色分析 │ │亮度分析 │ │噪声检测 │ │运动分析 │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                  │                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      数据存储层                                   │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐                │   │
│  │  │ MySQL   │ │ Redis   │ │ MinIO   │ │InfluxDB │                │   │
│  │  │ 元数据  │ │ 缓存    │ │ 文件    │ │ 时序    │                │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 二、诊断指标分类设计

### 2.1 图像质量指标

| 类别 | 指标名称 | 检测方法 | 适用场景 |
|------|----------|----------|----------|
| **清晰度** | 图像模糊 | Laplacian方差、Brenner梯度 | 图像/视频 |
| **遮挡类** | 画面遮挡 | 边缘检测+区域分析 | 图像/视频 |
| | 画面朝天 | 天空检测+纹理分析 | 图像/视频 |
| **颜色类** | 蓝屏/绿屏 | 颜色直方图+主色分析 | 图像/视频 |
| | 图像偏色 | 白平衡分析 | 图像/视频 |
| | 图像黑白 | 饱和度分析 | 图像/视频 |
| | 彩色条纹 | 频域分析+颜色分布 | 图像/视频 |
| **亮度类** | 图像过亮 | 亮度直方图分析 | 图像/视频 |
| | 图像过暗 | 亮度直方图分析 | 图像/视频 |
| | 对比度异常 | 对比度计算 | 图像/视频 |
| **干扰类** | 噪声干扰 | 高斯噪声检测 | 图像/视频 |
| | 条纹干扰 | FFT频域分析 | 图像/视频 |
| | 雪花/雪点 | 孤立点检测 | 图像/视频 |

### 2.2 视频流特有指标

| 类别 | 指标名称 | 检测方法 | 说明 |
|------|----------|----------|------|
| **信号类** | 信号丢失 | 帧差分析+黑屏检测 | 检测视频流中断 |
| **变化类** | 场景变换 | 帧间相似度 | 检测画面突然切换 |
| | 视频剧变 | 直方图差异 | 检测画面剧烈变化 |
| **冻结类** | 画面冻结 | 连续帧差值 | 检测静止画面 |
| **闪烁类** | 频闪 | 亮度周期性分析 | 检测画面闪烁 |
| **抖动类** | 视频抖动 | 光流法/特征点追踪 | 检测画面晃动 |
| | 滚屏 | 水平/垂直移动检测 | 检测画面滚动 |

## 三、技术选型建议

```
┌────────────────────────────────────────────────────────────────┐
│                         技术栈选型                              │
├────────────────────────────────────────────────────────────────┤
│  后端框架:    Python FastAPI / Go Gin                          │
│  算法核心:    OpenCV + NumPy + SciPy                           │
│  深度学习:    PyTorch / TensorFlow (可选,用于复杂检测)          │
│  视频处理:    FFmpeg + OpenCV                                   │
│  流媒体:      GStreamer / FFmpeg RTSP/RTMP                     │
│  消息队列:    Redis / RabbitMQ / Kafka                         │
│  任务调度:    Celery / APScheduler                             │
│  数据库:      PostgreSQL/MySQL + Redis + InfluxDB              │
│  对象存储:    MinIO / 阿里云OSS                                 │
│  前端:        React/Vue + ECharts/AntV                         │
│  容器化:      Docker + Kubernetes                              │
└────────────────────────────────────────────────────────────────┘
```

## 四、项目目录结构

```
originx/
├── README.md
├── requirements.txt
├── docker-compose.yml
├── .env.example
│
├── core/                          # 核心算法引擎
│   ├── __init__.py
│   ├── base.py                    # 基础检测器抽象类
│   ├── image/                     # 图像诊断算法
│   │   ├── __init__.py
│   │   ├── blur_detector.py       # 模糊检测
│   │   ├── color_analyzer.py      # 颜色分析(偏色/黑白/蓝屏)
│   │   ├── brightness_analyzer.py # 亮度分析(过亮/过暗/对比度)
│   │   ├── noise_detector.py      # 噪声检测(雪花/噪点)
│   │   ├── stripe_detector.py     # 条纹检测
│   │   └── occlusion_detector.py  # 遮挡检测
│   │
│   ├── video/                     # 视频诊断算法
│   │   ├── __init__.py
│   │   ├── freeze_detector.py     # 画面冻结
│   │   ├── scene_change.py        # 场景变换
│   │   ├── signal_loss.py         # 信号丢失
│   │   ├── flicker_detector.py    # 频闪检测
│   │   ├── shake_detector.py      # 抖动检测
│   │   └── scroll_detector.py     # 滚屏检测
│   │
│   └── pipeline.py                # 检测流水线
│
├── api/                           # API服务层
│   ├── __init__.py
│   ├── main.py                    # FastAPI入口
│   ├── routes/
│   │   ├── image.py               # 图像诊断API
│   │   ├── video.py               # 视频诊断API
│   │   ├── stream.py              # 流媒体诊断API
│   │   └── report.py              # 报告API
│   ├── schemas/                   # Pydantic模型
│   └── dependencies.py
│
├── services/                      # 业务服务层
│   ├── __init__.py
│   ├── diagnosis_service.py       # 诊断服务
│   ├── stream_service.py          # 流媒体服务
│   └── report_service.py          # 报告服务
│
├── workers/                       # 异步任务
│   ├── __init__.py
│   ├── celery_app.py
│   └── tasks.py
│
├── models/                        # 数据模型
│   ├── __init__.py
│   └── diagnosis.py
│
├── config/                        # 配置
│   ├── __init__.py
│   └── settings.py
│
├── utils/                         # 工具函数
│   ├── __init__.py
│   ├── image_utils.py
│   └── video_utils.py
│
├── tests/                         # 测试
│   ├── __init__.py
│   ├── test_blur.py
│   └── ...
│
└── frontend/                      # 前端 (可选)
    └── ...
```

## 五、核心算法说明

### 5.1 图像模糊检测

- **Laplacian方差法**: 计算图像拉普拉斯算子后的方差，方差越小说明越模糊
- **Brenner梯度法**: 计算相邻像素差的平方和
- **Tenengrad梯度法**: 使用Sobel算子计算梯度

### 5.2 颜色分析

- **偏色检测**: 分析RGB通道均值偏离程度
- **黑白检测**: 计算图像饱和度，低饱和度为黑白图像
- **蓝屏/绿屏检测**: 分析主色调占比

### 5.3 亮度分析

- **过亮/过暗检测**: 分析亮度直方图分布
- **对比度计算**: 计算图像像素值的标准差或动态范围

### 5.4 噪声检测

- **高斯噪声**: 使用局部方差估计
- **椒盐噪声**: 检测孤立的极值点
- **雪花噪声**: 形态学分析结合颜色特征

### 5.5 视频流分析

- **画面冻结**: 计算连续帧的SSIM或MSE
- **场景变换**: 使用直方图差异或特征点匹配
- **抖动检测**: 光流法或特征点追踪
- **频闪检测**: 亮度时序分析，检测周期性变化

## 六、扩展性设计

```
┌─────────────────────────────────────────────────────────────┐
│                      扩展性设计                              │
├─────────────────────────────────────────────────────────────┤
│  1. 插件化架构: 每个检测器独立，可动态加载                    │
│  2. 配置驱动: 阈值、参数可通过配置文件调整                    │
│  3. 多路并行: 支持同时诊断多路视频流                         │
│  4. GPU加速: 可选GPU加速模式 (CUDA/OpenCL)                  │
│  5. 分布式部署: 支持K8s水平扩展                             │
│  6. WebHook通知: 检测到异常时主动推送                        │
│  7. 告警规则引擎: 可自定义告警条件和级别                      │
└─────────────────────────────────────────────────────────────┘
```

## 七、部署架构

### 7.1 单机部署

适用于小规模场景（<1000路视频流）

```
┌─────────────────────────────────────┐
│           单机部署架构               │
├─────────────────────────────────────┤
│  Nginx (反向代理)                   │
│       ↓                             │
│  FastAPI (API服务)                  │
│       ↓                             │
│  Celery Workers (异步任务)          │
│       ↓                             │
│  Redis + PostgreSQL + MinIO         │
└─────────────────────────────────────┘
```

### 7.2 分布式部署

适用于大规模场景（>1000路视频流）

```
┌─────────────────────────────────────────────────────┐
│              分布式部署架构 (K8s)                    │
├─────────────────────────────────────────────────────┤
│  Ingress Controller                                 │
│       ↓                                             │
│  API Service (多副本)                               │
│       ↓                                             │
│  Kafka (消息队列)                                   │
│       ↓                                             │
│  Worker Pods (自动扩缩容)                           │
│       ↓                                             │
│  Redis Cluster + PostgreSQL HA + MinIO Cluster     │
└─────────────────────────────────────────────────────┘
```

