# OriginX V1.5 增强版 - 详细设计文档

> 版本目标：让产品从"能用"变成"好用"，为商业化验证做准备

## 一、版本概述

### 1.1 版本目标

| 目标 | 量化指标 | 优先级 |
|------|----------|--------|
| 视频检测能力 | 支持 MP4/AVI/MOV 格式，3个视频检测器 | P0 |
| RTSP/RTMP 流检测 | 支持主流视频流协议，实时检测 | P0 |
| 基准图像对比 | 支持与标准图像对比检测 | P1 |
| Web 管理界面 | 4个核心页面，无需命令行即可使用 | P0 |
| 定时任务 | 支持 Cron 表达式，最小粒度1分钟 | P1 |
| 报告增强 | 支持 Excel/PDF 导出 | P2 |
| 算法优化 | 误报率降低至 3% 以下 | P1 |

### 1.2 版本范围

```
┌─────────────────────────────────────────────────────────────────────┐
│                      V1.5 功能范围                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ✅ 本版本包含                         ❌ 本版本不包含              │
│   ─────────────────────────────────────────────────────────────     │
│   • 视频文件检测（MP4/AVI/MOV）         • 告警推送（邮件/短信）     │
│   • RTSP/RTMP 实时流检测                • 用户权限管理             │
│   • 画面冻结检测                         • 分布式部署               │
│   • 场景变换检测                         • 深度学习模型              │
│   • 视频抖动检测                         • 数据库持久化             │
│   • 基准图像对比检测                     • API 认证鉴权             │
│   • Web UI（检测/任务/设置）                                      │
│   • 定时任务调度                                                 │
│   • Excel/PDF 报告导出                                           │
│   • 阈值配置界面化                                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 系统架构（V1.5）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          OriginX V1.5 架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           接入层                                     │   │
│   │   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐   │   │
│   │   │  Web UI   │   │ REST API  │   │    CLI    │   │Python SDK │   │   │
│   │   │  (Vue3)   │   │ (FastAPI) │   │  (Click)  │   │           │   │   │
│   │   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘   │   │
│   │         └───────────────┴───────────────┴───────────────┘         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                       │                                     │
│   ┌───────────────────────────────────┴─────────────────────────────────┐   │
│   │                          服务层                                      │   │
│   │                                                                     │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │   │
│   │   │ Diagnosis   │  │  Scheduler  │  │   Report    │  │  Config   │ │   │
│   │   │  Service    │  │   Service   │  │   Service   │  │  Service  │ │   │
│   │   │ (诊断调度)  │  │ (定时任务)  │  │ (报告生成)  │  │ (配置管理)│ │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘ │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                       │                                     │
│   ┌───────────────────────────────────┴─────────────────────────────────┐   │
│   │                          核心层                                      │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Pipeline (检测流水线)                     │   │   │
│   │   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │   │
│   │   │   │ 图像输入 │  │ 视频输入 │  │ 检测执行 │  │ 结果聚合 │   │   │   │
│   │   │   │ Loader   │  │ Loader   │  │ Executor │  │Aggregator│   │   │   │
│   │   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                  检测器注册表 (Detector Registry)            │   │   │
│   │   │                                                             │   │   │
│   │   │   图像检测器 (V1.0)                                          │   │   │
│   │   │   ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐   │   │   │
│   │   │   │ Blur │ │Bright│ │Color │ │Noise │ │Stripe│ │Occlu-│   │   │   │
│   │   │   │      │ │ness  │ │      │ │      │ │      │ │sion  │   │   │   │
│   │   │   └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘   │   │   │
│   │   │   ┌──────┐ ┌──────┐                                        │   │   │
│   │   │   │Contra│ │Signal│                                        │   │   │
│   │   │   │st    │ │Loss  │                                        │   │   │
│   │   │   └──────┘ └──────┘                                        │   │   │
│   │   │                                                             │   │   │
│   │   │   视频检测器 (V1.5 新增)                                     │   │   │
│   │   │   ┌──────┐ ┌──────┐ ┌──────┐                               │   │   │
│   │   │   │Freeze│ │Scene │ │Shake │                               │   │   │
│   │   │   │      │ │Change│ │      │                               │   │   │
│   │   │   └──────┘ └──────┘ └──────┘                               │   │   │
│   │   │                                                             │   │   │
│   │   │   流检测器 (V1.5 新增)                                      │   │   │
│   │   │   ┌──────────┐  ┌──────────┐                              │   │   │
│   │   │   │RTSP Stream│  │RTMP Stream│                             │   │   │
│   │   │   │ Detector  │  │ Detector  │                             │   │   │
│   │   │   └──────────┘  └──────────┘                              │   │   │
│   │   │                                                             │   │   │
│   │   │   基准对比检测器 (V1.5 新增)                                │   │   │
│   │   │   ┌──────────────┐                                         │   │   │
│   │   │   │Baseline      │                                         │   │   │
│   │   │   │Comparison    │                                         │   │   │
│   │   │   └──────────────┘                                         │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         基础设施层                                   │   │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│   │   │ Storage  │  │  Logger  │  │  Config  │  │  Utils   │          │   │
│   │   │(文件存储)│  │ (日志)   │  │(YAML配置)│  │ (工具类) │          │   │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────┘          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、视频检测模块设计

### 2.1 视频处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          视频检测处理流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────┐                                                               │
│   │ 视频文件 │                                                               │
│   │MP4/AVI/ │                                                               │
│   │MOV/MKV  │                                                               │
│   └────┬────┘                                                               │
│        │                                                                    │
│        ▼                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      VideoLoader (视频加载器)                        │   │
│   │   • 使用 OpenCV VideoCapture                                        │   │
│   │   • 获取视频元数据（分辨率、帧率、时长、总帧数）                     │   │
│   │   • 支持大文件流式读取                                               │   │
│   └────────────────────────────────┬────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      FrameSampler (帧采样器)                         │   │
│   │                                                                     │   │
│   │   采样策略：                                                         │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │  固定间隔   │  │  场景变化   │  │   混合模式   │                │   │
│   │   │ (1fps默认) │  │ (变化时采样)│  │(固定+变化)  │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │                                                                     │   │
│   │   配置示例：                                                         │   │
│   │   sample_strategy: "interval"  # interval | scene | hybrid         │   │
│   │   sample_interval: 1.0         # 采样间隔（秒）                      │   │
│   │   scene_threshold: 0.3         # 场景变化阈值                        │   │
│   │   max_frames: 300              # 最大采样帧数                        │   │
│   │                                                                     │   │
│   └────────────────────────────────┬────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      FrameBuffer (帧缓冲区)                          │   │
│   │                                                                     │   │
│   │   • 存储连续N帧用于视频检测器                                        │   │
│   │   • 滑动窗口机制                                                     │   │
│   │   • 内存优化（超过阈值自动清理）                                     │   │
│   │                                                                     │   │
│   │   buffer_size: 30  # 缓冲区大小（帧数）                              │   │
│   │                                                                     │   │
│   └────────────────────────────────┬────────────────────────────────────┘   │
│                                    │                                        │
│        ┌───────────────────────────┼───────────────────────────┐           │
│        │                           │                           │           │
│        ▼                           ▼                           ▼           │
│   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │
│   │ 单帧检测器  │           │ 多帧检测器  │           │ 序列检测器  │      │
│   │ (图像检测) │           │ (视频检测) │           │ (视频检测) │      │
│   │             │           │             │           │             │      │
│   │ • Blur      │           │ • Freeze    │           │ • Shake     │      │
│   │ • Brightness│           │ • Scene     │           │             │      │
│   │ • Color     │           │   Change    │           │             │      │
│   │ • Noise     │           │             │           │             │      │
│   │ • ...       │           │             │           │             │      │
│   └──────┬──────┘           └──────┬──────┘           └──────┬──────┘      │
│          │                         │                         │             │
│          └─────────────────────────┴─────────────────────────┘             │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      VideoAggregator (视频聚合器)                    │   │
│   │                                                                     │   │
│   │   • 按时间窗口聚合检测结果                                           │   │
│   │   • 生成视频级别诊断报告                                             │   │
│   │   • 标记异常时间段                                                   │   │
│   │   • 计算整体质量评分                                                 │   │
│   │                                                                     │   │
│   └────────────────────────────────┬────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      VideoDiagnosisResult                            │   │
│   │                                                                     │   │
│   │   {                                                                 │   │
│   │     "video_path": "test.mp4",                                       │   │
│   │     "duration": 120.5,                                              │   │
│   │     "frame_count": 3015,                                            │   │
│   │     "sampled_frames": 120,                                          │   │
│   │     "is_abnormal": true,                                            │   │
│   │     "overall_score": 72.5,                                          │   │
│   │     "issues": [                                                     │   │
│   │       {"type": "freeze", "start": 45.2, "end": 47.8, ...},         │   │
│   │       {"type": "shake", "start": 102.1, "end": 105.3, ...}         │   │
│   │     ],                                                              │   │
│   │     "frame_results": [...]                                          │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 视频检测器详细设计

#### 2.2.1 画面冻结检测器 (FreezeDetector)

```python
"""
画面冻结检测器设计

原理：检测连续帧之间的相似度，如果连续N帧高度相似，判定为画面冻结

算法流程：
1. 计算相邻帧的结构相似度 (SSIM) 或直方图相似度
2. 如果相似度 > 阈值（如0.99），标记为静止帧
3. 统计连续静止帧数量
4. 如果连续静止帧 > 阈值（如30帧/1秒），判定为画面冻结
"""

class FreezeDetector(BaseVideoDetector):
    """画面冻结检测器"""
    
    name = "freeze"
    display_name = "画面冻结检测"
    description = "检测视频画面是否存在冻结/卡顿"
    
    # 配置参数
    default_config = {
        "similarity_threshold": 0.98,    # 帧相似度阈值
        "min_freeze_frames": 30,          # 最小冻结帧数
        "min_freeze_duration": 1.0,       # 最小冻结时长（秒）
        "method": "histogram",            # 相似度计算方法: histogram | ssim | mse
        "ignore_black_frames": True,      # 是否忽略黑屏帧
    }
    
    def detect(self, frame_buffer: List[np.ndarray], fps: float) -> VideoDetectionResult:
        """
        检测画面冻结
        
        Args:
            frame_buffer: 帧缓冲区（连续帧列表）
            fps: 视频帧率
            
        Returns:
            VideoDetectionResult: 检测结果
        """
        freeze_segments = []
        current_freeze_start = None
        consecutive_similar = 0
        
        for i in range(1, len(frame_buffer)):
            prev_frame = frame_buffer[i-1]
            curr_frame = frame_buffer[i]
            
            # 计算帧相似度
            similarity = self._calculate_similarity(prev_frame, curr_frame)
            
            if similarity > self.config["similarity_threshold"]:
                # 帧相似，可能是冻结
                if current_freeze_start is None:
                    current_freeze_start = i - 1
                consecutive_similar += 1
            else:
                # 帧不相似，检查是否形成冻结段
                if consecutive_similar >= self.config["min_freeze_frames"]:
                    freeze_segments.append({
                        "start_frame": current_freeze_start,
                        "end_frame": i - 1,
                        "duration_frames": consecutive_similar,
                        "duration_seconds": consecutive_similar / fps
                    })
                current_freeze_start = None
                consecutive_similar = 0
        
        # 处理结尾的冻结段
        if consecutive_similar >= self.config["min_freeze_frames"]:
            freeze_segments.append({
                "start_frame": current_freeze_start,
                "end_frame": len(frame_buffer) - 1,
                "duration_frames": consecutive_similar,
                "duration_seconds": consecutive_similar / fps
            })
        
        # 生成检测结果
        is_abnormal = len(freeze_segments) > 0
        total_freeze_duration = sum(seg["duration_seconds"] for seg in freeze_segments)
        
        return VideoDetectionResult(
            detector_name=self.name,
            is_abnormal=is_abnormal,
            score=total_freeze_duration,
            threshold=self.config["min_freeze_duration"],
            issue_type="freeze" if is_abnormal else "normal",
            segments=freeze_segments,
            explanation=self._generate_explanation(freeze_segments, total_freeze_duration),
            suggestions=self._generate_suggestions(is_abnormal),
            evidence={
                "freeze_count": len(freeze_segments),
                "total_freeze_duration": total_freeze_duration,
                "segments": freeze_segments
            }
        )
    
    def _calculate_similarity(self, frame1: np.ndarray, frame2: np.ndarray) -> float:
        """计算两帧的相似度"""
        if self.config["method"] == "histogram":
            return self._histogram_similarity(frame1, frame2)
        elif self.config["method"] == "ssim":
            return self._ssim_similarity(frame1, frame2)
        else:
            return self._mse_similarity(frame1, frame2)
```

#### 2.2.2 场景变换检测器 (SceneChangeDetector)

```python
"""
场景变换检测器设计

原理：检测视频中是否发生非预期的场景切换

算法流程：
1. 计算相邻帧的直方图差异
2. 计算边缘特征变化
3. 如果差异 > 阈值，标记为场景变换
4. 根据变换频率和幅度判断是否异常
"""

class SceneChangeDetector(BaseVideoDetector):
    """场景变换检测器"""
    
    name = "scene_change"
    display_name = "场景变换检测"
    description = "检测视频是否发生非预期的场景切换"
    
    default_config = {
        "histogram_threshold": 0.4,      # 直方图差异阈值
        "edge_threshold": 0.3,           # 边缘变化阈值
        "min_scene_duration": 2.0,       # 最小场景持续时长（秒）
        "max_changes_per_minute": 5,     # 每分钟最大变化次数
    }
    
    def detect(self, frame_buffer: List[np.ndarray], fps: float) -> VideoDetectionResult:
        """检测场景变换"""
        scene_changes = []
        
        for i in range(1, len(frame_buffer)):
            prev_frame = frame_buffer[i-1]
            curr_frame = frame_buffer[i]
            
            # 计算直方图差异
            hist_diff = self._histogram_difference(prev_frame, curr_frame)
            
            # 计算边缘差异
            edge_diff = self._edge_difference(prev_frame, curr_frame)
            
            # 综合判断
            if hist_diff > self.config["histogram_threshold"] or \
               edge_diff > self.config["edge_threshold"]:
                scene_changes.append({
                    "frame_index": i,
                    "timestamp": i / fps,
                    "histogram_diff": hist_diff,
                    "edge_diff": edge_diff
                })
        
        # 判断是否异常
        video_duration = len(frame_buffer) / fps
        changes_per_minute = len(scene_changes) / (video_duration / 60) if video_duration > 0 else 0
        is_abnormal = changes_per_minute > self.config["max_changes_per_minute"]
        
        return VideoDetectionResult(
            detector_name=self.name,
            is_abnormal=is_abnormal,
            score=changes_per_minute,
            threshold=self.config["max_changes_per_minute"],
            issue_type="scene_change" if is_abnormal else "normal",
            segments=scene_changes,
            explanation=self._generate_explanation(scene_changes, changes_per_minute),
            suggestions=self._generate_suggestions(is_abnormal),
            evidence={
                "scene_change_count": len(scene_changes),
                "changes_per_minute": changes_per_minute,
                "changes": scene_changes
            }
        )
```

#### 2.2.3 视频抖动检测器 (ShakeDetector)

```python
"""
视频抖动检测器设计

原理：通过光流法或特征点跟踪检测画面整体位移

算法流程：
1. 使用 Lucas-Kanade 光流法跟踪特征点
2. 计算帧间全局运动向量
3. 分析运动向量的方差
4. 如果方差超过阈值，判定为抖动
"""

class ShakeDetector(BaseVideoDetector):
    """视频抖动检测器"""
    
    name = "shake"
    display_name = "视频抖动检测"
    description = "检测视频画面是否存在抖动/晃动"
    
    default_config = {
        "motion_threshold": 5.0,         # 运动向量阈值（像素）
        "variance_threshold": 10.0,      # 方差阈值
        "min_shake_duration": 0.5,       # 最小抖动持续时长（秒）
        "feature_count": 100,            # 跟踪特征点数量
    }
    
    def detect(self, frame_buffer: List[np.ndarray], fps: float) -> VideoDetectionResult:
        """检测视频抖动"""
        motion_vectors = []
        
        # 获取第一帧的特征点
        prev_gray = cv2.cvtColor(frame_buffer[0], cv2.COLOR_BGR2GRAY)
        prev_points = cv2.goodFeaturesToTrack(
            prev_gray, 
            maxCorners=self.config["feature_count"],
            qualityLevel=0.01,
            minDistance=10
        )
        
        for i in range(1, len(frame_buffer)):
            curr_gray = cv2.cvtColor(frame_buffer[i], cv2.COLOR_BGR2GRAY)
            
            if prev_points is not None and len(prev_points) > 0:
                # 计算光流
                curr_points, status, _ = cv2.calcOpticalFlowPyrLK(
                    prev_gray, curr_gray, prev_points, None
                )
                
                # 计算有效点的运动向量
                valid_prev = prev_points[status == 1]
                valid_curr = curr_points[status == 1]
                
                if len(valid_prev) > 0:
                    motion = valid_curr - valid_prev
                    mean_motion = np.mean(motion, axis=0)
                    motion_magnitude = np.linalg.norm(mean_motion)
                    motion_vectors.append({
                        "frame_index": i,
                        "motion_x": float(mean_motion[0]),
                        "motion_y": float(mean_motion[1]),
                        "magnitude": float(motion_magnitude)
                    })
            
            # 更新特征点
            prev_gray = curr_gray
            prev_points = cv2.goodFeaturesToTrack(
                prev_gray,
                maxCorners=self.config["feature_count"],
                qualityLevel=0.01,
                minDistance=10
            )
        
        # 分析抖动
        if len(motion_vectors) > 0:
            magnitudes = [mv["magnitude"] for mv in motion_vectors]
            motion_variance = np.var(magnitudes)
            max_motion = max(magnitudes)
        else:
            motion_variance = 0
            max_motion = 0
        
        is_abnormal = motion_variance > self.config["variance_threshold"]
        
        return VideoDetectionResult(
            detector_name=self.name,
            is_abnormal=is_abnormal,
            score=motion_variance,
            threshold=self.config["variance_threshold"],
            issue_type="shake" if is_abnormal else "normal",
            explanation=self._generate_explanation(motion_variance, max_motion),
            suggestions=self._generate_suggestions(is_abnormal),
            evidence={
                "motion_variance": motion_variance,
                "max_motion": max_motion,
                "motion_vectors": motion_vectors[:10]  # 只保存前10个
            }
        )
```

### 2.3 视频检测 API 设计

```python
# API 端点设计

# POST /api/v1/diagnose/video
# 视频文件检测
{
    "request": {
        "video": "base64 或 multipart/form-data",
        "profile": "normal",  # strict | normal | loose
        "level": "standard",  # fast | standard | deep
        "detectors": ["freeze", "scene_change", "shake"],  # 可选，默认全部
        "sample_strategy": "interval",  # interval | scene | hybrid
        "sample_interval": 1.0,
        "include_frame_results": false  # 是否返回逐帧结果
    },
    "response": {
        "video_id": "uuid",
        "video_path": "test.mp4",
        "duration": 120.5,
        "frame_count": 3015,
        "sampled_frames": 120,
        "is_abnormal": true,
        "overall_score": 72.5,
        "primary_issue": "freeze",
        "severity": "warning",
        "issues": [
            {
                "type": "freeze",
                "start_time": 45.2,
                "end_time": 47.8,
                "duration": 2.6,
                "severity": "warning",
                "confidence": 0.95
            }
        ],
        "detection_results": [
            {
                "detector_name": "freeze",
                "is_abnormal": true,
                "score": 2.6,
                "threshold": 1.0,
                ...
            }
        ],
        "process_time_ms": 3500.5
    }
}

# GET /api/v1/diagnose/video/{video_id}/frames
# 获取视频帧级检测结果
{
    "response": {
        "video_id": "uuid",
        "frame_results": [
            {
                "frame_index": 0,
                "timestamp": 0.0,
                "detections": {...}
            }
        ]
    }
}
```

### 2.4 RTSP/RTMP 实时流检测设计

#### 2.4.1 流媒体处理架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RTSP/RTMP 实时流检测架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                      Stream Manager (流管理器)                     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Stream Pool (流池)                       │   │   │
│   │   │                                                             │   │   │
│   │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐      ┌─────────┐   │   │   │
│   │   │   │Stream 1 │  │Stream 2 │  │Stream 3 │ .... │Stream N │   │   │   │
│   │   │   │(RTSP)   │  │(RTMP)   │  │(RTSP)   │      │         │   │   │   │
│   │   │   │rtsp://  │  │rtmp://  │  │rtsp://  │      │         │   │   │   │
│   │   │   └────┬────┘  └────┬────┘  └────┬────┘      └────┬────┘   │   │   │
│   │   │        │            │            │                │        │   │   │
│   │   └────────┼────────────┼────────────┼────────────────┼────────┘   │   │
│   │            │            │            │                │             │   │
│   │            ▼            ▼            ▼                ▼             │   │
│   │   ┌────────────────────────────────────────────────────────────┐   │   │
│   │   │              Stream Capture (流捕获器)                      │   │   │
│   │   │   • 使用 OpenCV VideoCapture 或 FFmpeg                      │   │   │
│   │   │   • 支持 RTSP (TCP/UDP)                                    │   │   │
│   │   │   • 支持 RTMP                                              │   │   │
│   │   │   • 自动重连机制                                           │   │   │
│   │   │   • 连接状态监控                                           │   │   │
│   │   └────────────────────────────────────────────────────────────┘   │   │
│   │            │                                                      │   │
│   │            ▼                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────┐   │   │
│   │   │              Frame Buffer (帧缓冲区)                          │   │   │
│   │   │   • 滑动窗口（保留最近N帧）                                 │   │   │
│   │   │   • 采样策略：固定间隔 / 智能采样                            │   │   │
│   │   │   • 内存管理（自动清理旧帧）                                │   │   │
│   │   └────────────────────────────────────────────────────────────┘   │   │
│   │            │                                                      │   │
│   │            ▼                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────┐   │   │
│   │   │              Detection Worker (检测工作器)                   │   │   │
│   │   │   ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐          │   │   │
│   │   │   │Worker 1│  │Worker 2│  │Worker 3│  │Worker N│          │   │   │
│   │   │   └────────┘  └────────┘  └────────┘  └────────┘          │   │   │
│   │   │   • 异步检测（不阻塞流接收）                                │   │   │
│   │   │   • 多线程/多进程处理                                       │   │   │
│   │   └────────────────────────────────────────────────────────────┘   │   │
│   │            │                                                      │   │
│   │            ▼                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────┐   │   │
│   │   │              Result Aggregator (结果聚合器)                 │   │   │
│   │   │   • 时间窗口聚合（如：每10秒汇总一次）                      │   │   │
│   │   │   • 异常去重（避免重复告警）                                │   │   │
│   │   │   • 告警阈值判断                                           │   │   │
│   │   └────────────────────────────────────────────────────────────┘   │   │
│   │            │                                                      │   │
│   │            ▼                                                      │   │
│   │   ┌────────────────────────────────────────────────────────────┐   │   │
│   │   │              Alert Engine (告警引擎)                        │   │   │
│   │   │   • 异常聚合（避免告警风暴）                                │   │   │
│   │   │   • 告警去重（相同问题不重复告警）                          │   │   │
│   │   │   • 告警升级（问题持续时升级严重度）                        │   │   │
│   │   │   • WebSocket 实时推送（V1.5 基础版，V2.0 完善）            │   │   │
│   │   └────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.4.2 流检测器实现

```python
"""
RTSP/RTMP 流检测器设计

技术选型：
- OpenCV VideoCapture: 支持 RTSP (TCP/UDP)
- FFmpeg-python: 作为备选方案，支持更多协议
- 多线程处理：流接收与检测分离
"""

import cv2
import threading
from queue import Queue
from typing import Optional, Callable
from datetime import datetime
import time

class StreamDetector:
    """实时流检测器"""
    
    def __init__(
        self,
        stream_url: str,
        stream_type: str = "rtsp",  # rtsp | rtmp
        sample_interval: float = 1.0,  # 采样间隔（秒）
        buffer_size: int = 30,  # 帧缓冲区大小
        detection_callback: Optional[Callable] = None,  # 检测结果回调
        reconnect_interval: int = 5,  # 重连间隔（秒）
        max_reconnect_attempts: int = 10,  # 最大重连次数
    ):
        self.stream_url = stream_url
        self.stream_type = stream_type
        self.sample_interval = sample_interval
        self.buffer_size = buffer_size
        self.detection_callback = detection_callback
        self.reconnect_interval = reconnect_interval
        self.max_reconnect_attempts = max_reconnect_attempts
        
        self.cap: Optional[cv2.VideoCapture] = None
        self.frame_buffer: Queue = Queue(maxsize=buffer_size)
        self.is_running = False
        self.is_connected = False
        self.reconnect_count = 0
        
        # 线程
        self.capture_thread: Optional[threading.Thread] = None
        self.detection_thread: Optional[threading.Thread] = None
        
        # 统计信息
        self.stats = {
            "frames_received": 0,
            "frames_detected": 0,
            "connection_errors": 0,
            "last_frame_time": None,
            "fps": 0.0,
        }
    
    def start(self):
        """启动流检测"""
        if self.is_running:
            return
        
        self.is_running = True
        self._connect()
        
        # 启动帧捕获线程
        self.capture_thread = threading.Thread(
            target=self._capture_loop,
            daemon=True
        )
        self.capture_thread.start()
        
        # 启动检测线程
        self.detection_thread = threading.Thread(
            target=self._detection_loop,
            daemon=True
        )
        self.detection_thread.start()
    
    def stop(self):
        """停止流检测"""
        self.is_running = False
        if self.cap:
            self.cap.release()
        self.is_connected = False
    
    def _connect(self):
        """连接流"""
        try:
            # RTSP 配置
            if self.stream_type == "rtsp":
                # 使用 TCP 传输（更稳定）
                rtsp_url = self.stream_url
                if "?tcp" not in rtsp_url:
                    separator = "&" if "?" in rtsp_url else "?"
                    rtsp_url = f"{self.stream_url}{separator}tcp=1"
                
                self.cap = cv2.VideoCapture(rtsp_url, cv2.CAP_FFMPEG)
                # 设置缓冲区大小（减少延迟）
                self.cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            else:
                # RTMP
                self.cap = cv2.VideoCapture(self.stream_url, cv2.CAP_FFMPEG)
                self.cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)
            
            if self.cap.isOpened():
                self.is_connected = True
                self.reconnect_count = 0
                return True
            else:
                raise Exception("Failed to open stream")
        except Exception as e:
            self.is_connected = False
            self.stats["connection_errors"] += 1
            raise
    
    def _capture_loop(self):
        """帧捕获循环"""
        last_sample_time = 0
        
        while self.is_running:
            try:
                if not self.is_connected:
                    # 尝试重连
                    if self.reconnect_count < self.max_reconnect_attempts:
                        time.sleep(self.reconnect_interval)
                        try:
                            self._connect()
                        except:
                            self.reconnect_count += 1
                            continue
                    else:
                        # 超过最大重连次数，停止
                        self.is_running = False
                        break
                
                ret, frame = self.cap.read()
                if not ret:
                    # 读取失败，标记为断开
                    self.is_connected = False
                    self.reconnect_count += 1
                    continue
                
                # 采样控制
                current_time = time.time()
                if current_time - last_sample_time >= self.sample_interval:
                    # 添加到缓冲区（如果已满，移除最旧的）
                    if self.frame_buffer.full():
                        try:
                            self.frame_buffer.get_nowait()
                        except:
                            pass
                    
                    self.frame_buffer.put({
                        "frame": frame,
                        "timestamp": current_time,
                        "frame_index": self.stats["frames_received"]
                    })
                    
                    self.stats["frames_received"] += 1
                    self.stats["last_frame_time"] = current_time
                    last_sample_time = current_time
                
                # 计算 FPS
                if self.stats["frames_received"] > 0:
                    elapsed = current_time - (self.stats.get("start_time") or current_time)
                    if elapsed > 0:
                        self.stats["fps"] = self.stats["frames_received"] / elapsed
                
            except Exception as e:
                self.is_connected = False
                self.stats["connection_errors"] += 1
                time.sleep(1)
    
    def _detection_loop(self):
        """检测循环"""
        from core.pipeline import ImagePipeline
        from core.video_pipeline import VideoPipeline
        
        pipeline = ImagePipeline()
        video_pipeline = VideoPipeline()
        
        last_detection_time = 0
        detection_interval = 5.0  # 每5秒检测一次
        
        while self.is_running:
            try:
                current_time = time.time()
                
                # 检测间隔控制
                if current_time - last_detection_time < detection_interval:
                    time.sleep(0.1)
                    continue
                
                # 从缓冲区获取帧
                frames = []
                buffer_copy = list(self.frame_buffer.queue)
                
                if len(buffer_copy) == 0:
                    time.sleep(0.1)
                    continue
                
                # 获取最近N帧用于视频检测
                recent_frames = buffer_copy[-min(30, len(buffer_copy)):]
                frames = [item["frame"] for item in recent_frames]
                
                if len(frames) == 0:
                    continue
                
                # 执行检测
                # 单帧检测（图像检测器）
                latest_frame = frames[-1]
                image_result = pipeline.detect(latest_frame)
                
                # 多帧检测（视频检测器）
                video_result = video_pipeline.detect(frames, fps=self.stats["fps"])
                
                # 聚合结果
                result = {
                    "stream_url": self.stream_url,
                    "timestamp": current_time,
                    "is_connected": self.is_connected,
                    "fps": self.stats["fps"],
                    "image_detection": image_result,
                    "video_detection": video_result,
                    "is_abnormal": image_result.is_abnormal or video_result.is_abnormal,
                }
                
                self.stats["frames_detected"] += 1
                last_detection_time = current_time
                
                # 回调通知
                if self.detection_callback:
                    self.detection_callback(result)
                
            except Exception as e:
                time.sleep(1)
```

#### 2.4.3 流检测 API 设计

```python
# POST /api/v1/diagnose/stream/start
# 启动流检测
{
    "request": {
        "stream_url": "rtsp://192.168.1.100:554/stream",
        "stream_type": "rtsp",  # rtsp | rtmp
        "sample_interval": 1.0,  # 采样间隔（秒）
        "detection_interval": 5.0,  # 检测间隔（秒）
        "profile": "normal",
        "level": "standard",
        "detectors": ["freeze", "scene_change", "shake"],  # 可选
        "callback_url": "http://example.com/webhook"  # 可选，结果回调
    },
    "response": {
        "stream_id": "stream-uuid",
        "status": "running",
        "stream_url": "rtsp://192.168.1.100:554/stream",
        "started_at": "2024-01-08T10:00:00"
    }
}

# GET /api/v1/diagnose/stream/{stream_id}/status
# 获取流检测状态
{
    "response": {
        "stream_id": "stream-uuid",
        "status": "running",  # running | stopped | error
        "is_connected": true,
        "fps": 25.0,
        "frames_received": 1500,
        "frames_detected": 300,
        "last_detection_time": "2024-01-08T10:05:00",
        "connection_errors": 0,
        "reconnect_count": 0
    }
}

# GET /api/v1/diagnose/stream/{stream_id}/results
# 获取检测结果（最近N条）
{
    "request": {
        "limit": 100,  # 可选，默认100
        "since": "2024-01-08T10:00:00"  # 可选，时间范围
    },
    "response": {
        "stream_id": "stream-uuid",
        "results": [
            {
                "timestamp": "2024-01-08T10:05:00",
                "is_abnormal": true,
                "primary_issue": "freeze",
                "severity": "warning",
                "image_detection": {...},
                "video_detection": {...}
            }
        ],
        "total": 300
    }
}

# POST /api/v1/diagnose/stream/{stream_id}/stop
# 停止流检测
{
    "response": {
        "stream_id": "stream-uuid",
        "status": "stopped",
        "stopped_at": "2024-01-08T10:10:00",
        "total_detections": 300
    }
}

# GET /api/v1/diagnose/streams
# 获取所有流检测列表
{
    "response": {
        "streams": [
            {
                "stream_id": "stream-uuid-1",
                "stream_url": "rtsp://...",
                "status": "running",
                "started_at": "2024-01-08T10:00:00"
            }
        ],
        "total": 5
    }
}
```

#### 2.4.4 WebSocket 实时推送（V1.5 基础版）

```python
# WebSocket 端点: /ws/stream/{stream_id}
# 实时推送检测结果

{
    "type": "detection_result",
    "data": {
        "stream_id": "stream-uuid",
        "timestamp": "2024-01-08T10:05:00",
        "is_abnormal": true,
        "primary_issue": "freeze",
        "severity": "warning",
        "details": {...}
    }
}

{
    "type": "stream_status",
    "data": {
        "stream_id": "stream-uuid",
        "is_connected": true,
        "fps": 25.0,
        "status": "running"
    }
}

{
    "type": "connection_error",
    "data": {
        "stream_id": "stream-uuid",
        "error": "Connection lost",
        "reconnect_attempts": 3
    }
}
```

---

## 二、基准图像对比检测设计

### 2.1 功能概述

基准图像对比检测允许用户上传一张标准参考图像，系统将待检测图像与参考图像进行对比，检测是否存在显著差异。

**应用场景：**
- 监控摄像头画面异常检测（与正常画面对比）
- 产品质量检测（与标准样品对比）
- 设备状态监控（与正常状态对比）

### 2.2 对比算法设计

#### 2.2.1 多维度对比策略

```python
"""
基准图像对比检测器设计

对比维度：
1. 结构相似度 (SSIM)
2. 直方图相似度
3. 特征点匹配
4. 区域差异分析
"""

import cv2
import numpy as np
from skimage.metrics import structural_similarity as ssim
from typing import Dict, Any, Optional

class BaselineComparisonDetector:
    """基准图像对比检测器"""
    
    name = "baseline_comparison"
    display_name = "基准图像对比"
    description = "与标准参考图像进行对比检测"
    
    default_config = {
        "ssim_threshold": 0.85,          # SSIM 相似度阈值
        "histogram_threshold": 0.80,      # 直方图相似度阈值
        "feature_match_threshold": 0.7,   # 特征点匹配阈值
        "diff_threshold": 0.15,           # 差异阈值（15%）
        "enable_region_analysis": True,   # 是否启用区域差异分析
        "region_grid_size": 3,           # 区域网格大小（3x3）
    }
    
    def __init__(self, baseline_image: np.ndarray, config: Optional[Dict] = None):
        """
        初始化对比检测器
        
        Args:
            baseline_image: 基准参考图像（BGR格式）
            config: 配置参数
        """
        self.baseline_image = baseline_image
        self.config = {**self.default_config, **(config or {})}
        
        # 预处理基准图像
        self.baseline_gray = cv2.cvtColor(baseline_image, cv2.COLOR_BGR2GRAY)
        self.baseline_hist = self._calculate_histogram(baseline_image)
        self.baseline_features = self._extract_features(self.baseline_gray)
    
    def compare(self, target_image: np.ndarray) -> Dict[str, Any]:
        """
        对比目标图像与基准图像
        
        Args:
            target_image: 待检测图像（BGR格式）
            
        Returns:
            对比结果字典
        """
        # 确保图像尺寸一致
        if target_image.shape != self.baseline_image.shape:
            target_image = cv2.resize(
                target_image,
                (self.baseline_image.shape[1], self.baseline_image.shape[0])
            )
        
        target_gray = cv2.cvtColor(target_image, cv2.COLOR_BGR2GRAY)
        target_hist = self._calculate_histogram(target_image)
        target_features = self._extract_features(target_gray)
        
        # 1. SSIM 结构相似度
        ssim_score = self._calculate_ssim(self.baseline_gray, target_gray)
        
        # 2. 直方图相似度
        hist_similarity = self._compare_histograms(self.baseline_hist, target_hist)
        
        # 3. 特征点匹配
        feature_match_score = self._match_features(
            self.baseline_features,
            target_features
        )
        
        # 4. 区域差异分析
        region_diffs = []
        if self.config["enable_region_analysis"]:
            region_diffs = self._analyze_region_differences(
                self.baseline_gray,
                target_gray
            )
        
        # 5. 综合判断
        is_abnormal = self._judge_abnormal(
            ssim_score,
            hist_similarity,
            feature_match_score,
            region_diffs
        )
        
        # 6. 差异可视化
        diff_image = self._visualize_difference(
            self.baseline_image,
            target_image
        )
        
        return {
            "is_abnormal": is_abnormal,
            "ssim_score": ssim_score,
            "histogram_similarity": hist_similarity,
            "feature_match_score": feature_match_score,
            "region_differences": region_diffs,
            "overall_similarity": (ssim_score + hist_similarity + feature_match_score) / 3,
            "diff_image": diff_image,
            "explanation": self._generate_explanation(
                is_abnormal,
                ssim_score,
                hist_similarity,
                feature_match_score
            ),
            "suggestions": self._generate_suggestions(is_abnormal)
        }
    
    def _calculate_ssim(self, img1: np.ndarray, img2: np.ndarray) -> float:
        """计算 SSIM"""
        score = ssim(img1, img2, data_range=255)
        return float(score)
    
    def _calculate_histogram(self, image: np.ndarray) -> np.ndarray:
        """计算颜色直方图"""
        hist_b = cv2.calcHist([image], [0], None, [256], [0, 256])
        hist_g = cv2.calcHist([image], [1], None, [256], [0, 256])
        hist_r = cv2.calcHist([image], [2], None, [256], [0, 256])
        hist = np.concatenate([hist_b, hist_g, hist_r])
        return hist
    
    def _compare_histograms(self, hist1: np.ndarray, hist2: np.ndarray) -> float:
        """比较直方图相似度"""
        similarity = cv2.compareHist(hist1, hist2, cv2.HISTCMP_CORREL)
        return float(similarity)
    
    def _extract_features(self, image: np.ndarray) -> tuple:
        """提取特征点"""
        # 使用 ORB 特征检测器
        orb = cv2.ORB_create(nfeatures=500)
        keypoints, descriptors = orb.detectAndCompute(image, None)
        return (keypoints, descriptors)
    
    def _match_features(
        self,
        features1: tuple,
        features2: tuple
    ) -> float:
        """匹配特征点"""
        kp1, desc1 = features1
        kp2, desc2 = features2
        
        if desc1 is None or desc2 is None:
            return 0.0
        
        # 使用 BFMatcher
        bf = cv2.BFMatcher(cv2.NORM_HAMMING, crossCheck=True)
        matches = bf.match(desc1, desc2)
        
        if len(matches) == 0:
            return 0.0
        
        # 计算匹配分数
        match_score = len(matches) / max(len(kp1), len(kp2))
        return float(match_score)
    
    def _analyze_region_differences(
        self,
        img1: np.ndarray,
        img2: np.ndarray
    ) -> list:
        """区域差异分析"""
        h, w = img1.shape
        grid_size = self.config["region_grid_size"]
        cell_h = h // grid_size
        cell_w = w // grid_size
        
        region_diffs = []
        
        for i in range(grid_size):
            for j in range(grid_size):
                y1 = i * cell_h
                y2 = (i + 1) * cell_h if i < grid_size - 1 else h
                x1 = j * cell_w
                x2 = (j + 1) * cell_w if j < grid_size - 1 else w
                
                region1 = img1[y1:y2, x1:x2]
                region2 = img2[y1:y2, x1:x2]
                
                # 计算区域 SSIM
                region_ssim = ssim(region1, region2, data_range=255)
                
                region_diffs.append({
                    "region": (i, j),
                    "bbox": (x1, y1, x2, y2),
                    "ssim": float(region_ssim),
                    "is_abnormal": region_ssim < self.config["ssim_threshold"]
                })
        
        return region_diffs
    
    def _judge_abnormal(
        self,
        ssim_score: float,
        hist_similarity: float,
        feature_match_score: float,
        region_diffs: list
    ) -> bool:
        """判断是否异常"""
        # 主要指标判断
        if ssim_score < self.config["ssim_threshold"]:
            return True
        if hist_similarity < self.config["histogram_threshold"]:
            return True
        if feature_match_score < self.config["feature_match_threshold"]:
            return True
        
        # 区域差异判断
        if region_diffs:
            abnormal_regions = [
                r for r in region_diffs
                if r["is_abnormal"]
            ]
            abnormal_ratio = len(abnormal_regions) / len(region_diffs)
            if abnormal_ratio > self.config["diff_threshold"]:
                return True
        
        return False
    
    def _visualize_difference(
        self,
        img1: np.ndarray,
        img2: np.ndarray
    ) -> np.ndarray:
        """可视化差异"""
        # 计算差异图
        diff = cv2.absdiff(img1, img2)
        diff_gray = cv2.cvtColor(diff, cv2.COLOR_BGR2GRAY)
        
        # 阈值化
        _, thresh = cv2.threshold(diff_gray, 30, 255, cv2.THRESH_BINARY)
        
        # 叠加到原图
        result = img2.copy()
        result[thresh > 0] = [0, 0, 255]  # 差异区域标红
        
        return result
    
    def _generate_explanation(
        self,
        is_abnormal: bool,
        ssim_score: float,
        hist_similarity: float,
        feature_match_score: float
    ) -> str:
        """生成解释说明"""
        if is_abnormal:
            reasons = []
            if ssim_score < self.config["ssim_threshold"]:
                reasons.append(f"结构相似度较低 ({ssim_score:.2f})")
            if hist_similarity < self.config["histogram_threshold"]:
                reasons.append(f"颜色分布差异较大 ({hist_similarity:.2f})")
            if feature_match_score < self.config["feature_match_threshold"]:
                reasons.append(f"特征匹配度较低 ({feature_match_score:.2f})")
            
            return f"检测到与基准图像存在显著差异：{', '.join(reasons)}"
        else:
            return f"与基准图像相似度较高 (SSIM: {ssim_score:.2f}, 直方图: {hist_similarity:.2f}, 特征: {feature_match_score:.2f})"
    
    def _generate_suggestions(self, is_abnormal: bool) -> list:
        """生成改进建议"""
        if is_abnormal:
            return [
                "检查摄像头位置是否发生变化",
                "检查画面内容是否正常",
                "检查光照条件是否一致",
                "如为正常变化，请更新基准图像"
            ]
        else:
            return ["画面与基准图像一致，状态正常"]
```

### 2.3 基准图像对比 API 设计

```python
# POST /api/v1/diagnose/image/with-baseline
# 使用基准图像对比检测
{
    "request": {
        "image": "base64 或 multipart/form-data",  # 待检测图像
        "baseline_image": "base64 或 multipart/form-data",  # 基准图像
        "baseline_id": "baseline-uuid",  # 可选，使用已保存的基准图像
        "profile": "normal",
        "level": "standard",
        "comparison_config": {
            "ssim_threshold": 0.85,
            "histogram_threshold": 0.80,
            "enable_region_analysis": true
        }
    },
    "response": {
        "task_id": "uuid",
        "is_abnormal": true,
        "overall_similarity": 0.72,
        "comparison_result": {
            "ssim_score": 0.68,
            "histogram_similarity": 0.75,
            "feature_match_score": 0.73,
            "region_differences": [
                {
                    "region": (0, 0),
                    "bbox": [0, 0, 640, 360],
                    "ssim": 0.65,
                    "is_abnormal": true
                }
            ]
        },
        "diff_image": "base64",  # 差异可视化图像
        "explanation": "检测到与基准图像存在显著差异：结构相似度较低 (0.68)",
        "suggestions": [
            "检查摄像头位置是否发生变化",
            "检查画面内容是否正常"
        ],
        "detection_results": [...],  # 常规检测结果
        "process_time_ms": 125.5
    }
}

# POST /api/v1/baseline/images
# 保存基准图像
{
    "request": {
        "name": "监控点A-正常画面",
        "description": "监控点A的正常状态参考图像",
        "image": "base64 或 multipart/form-data",
        "tags": ["监控点A", "正常状态"]
    },
    "response": {
        "baseline_id": "baseline-uuid",
        "name": "监控点A-正常画面",
        "created_at": "2024-01-08T10:00:00"
    }
}

# GET /api/v1/baseline/images
# 获取基准图像列表
{
    "response": {
        "baselines": [
            {
                "baseline_id": "baseline-uuid",
                "name": "监控点A-正常画面",
                "description": "监控点A的正常状态参考图像",
                "created_at": "2024-01-08T10:00:00",
                "tags": ["监控点A", "正常状态"]
            }
        ],
        "total": 10
    }
}

# GET /api/v1/baseline/images/{baseline_id}
# 获取基准图像详情
{
    "response": {
        "baseline_id": "baseline-uuid",
        "name": "监控点A-正常画面",
        "description": "监控点A的正常状态参考图像",
        "image_url": "/api/v1/baseline/images/{baseline_id}/image",
        "created_at": "2024-01-08T10:00:00",
        "tags": ["监控点A", "正常状态"]
    }
}

# DELETE /api/v1/baseline/images/{baseline_id}
# 删除基准图像
```

---

## 三、Web UI 模块设计

### 3.1 技术选型

| 技术 | 选型 | 理由 |
|------|------|------|
| **框架** | Vue 3 + TypeScript | 上手快、生态完善、与Python后端配合好 |
| **UI库** | Element Plus | 企业级组件库、中文友好 |
| **构建** | Vite | 开发体验好、构建快 |
| **状态管理** | Pinia | Vue 3 官方推荐 |
| **HTTP** | Axios | 成熟稳定 |
| **图表** | ECharts | 功能强大、中文友好 |

### 3.2 页面结构设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Web UI 页面结构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           顶部导航栏                                 │   │
│   │   ┌──────┐  ┌──────────────────────────────────────┐  ┌──────────┐ │   │
│   │   │ Logo │  │  仪表盘 │ 检测中心 │ 任务管理 │ 设置  │  │ 用户头像 │ │   │
│   │   └──────┘  └──────────────────────────────────────┘  └──────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                           页面内容区                                 │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  页面1: 仪表盘 (Dashboard)                                   │   │   │
│   │   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │   │   │
│   │   │  │  统计卡片   │ │  统计卡片   │ │    检测趋势图表     │   │   │   │
│   │   │  │  今日检测   │ │  异常数量   │ │                     │   │   │   │
│   │   │  └─────────────┘ └─────────────┘ └─────────────────────┘   │   │   │
│   │   │  ┌─────────────────────────────┐ ┌─────────────────────┐   │   │   │
│   │   │  │      最近检测记录          │ │   异常类型分布      │   │   │   │
│   │   │  │                            │ │   (饼图)            │   │   │   │
│   │   │  └─────────────────────────────┘ └─────────────────────┘   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  页面2: 检测中心 (Detection)                                 │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  Tab: 单图检测 │ 批量检测 │ 视频检测                  │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │                                                       │   │   │   │
│   │   │  │   ┌─────────────────────────────────────────────┐    │   │   │   │
│   │   │  │   │            拖拽上传区域                      │    │   │   │   │
│   │   │  │   │          点击或拖拽上传文件                  │    │   │   │   │
│   │   │  │   └─────────────────────────────────────────────┘    │   │   │   │
│   │   │  │                                                       │   │   │   │
│   │   │  │   ┌──────────────────┐  ┌─────────────────────────┐  │   │   │   │
│   │   │  │   │    配置选项      │  │      检测结果展示       │  │   │   │   │
│   │   │  │   │ • 检测模板       │  │                         │  │   │   │   │
│   │   │  │   │ • 检测级别       │  │                         │  │   │   │   │
│   │   │  │   │ • 检测器选择     │  │                         │  │   │   │   │
│   │   │  │   └──────────────────┘  └─────────────────────────┘  │   │   │   │
│   │   │  │                                                       │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  页面3: 任务管理 (Tasks)                                     │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  [新建任务]  [刷新]                                    │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  任务名称     │ 类型  │ Cron表达式  │ 状态 │ 操作     │   │   │   │
│   │   │  │  ─────────────────────────────────────────────────────│   │   │   │
│   │   │  │  每日巡检     │ 批量  │ 0 2 * * *  │ 启用 │ 编辑/删除│   │   │   │
│   │   │  │  高峰期抽检   │ 抽样  │ 0 9,18 * * │ 启用 │ 编辑/删除│   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  执行历史                                              │   │   │   │
│   │   │  │  时间              │ 任务名称  │ 结果 │ 耗时  │ 操作 │   │   │   │
│   │   │  │  2024-01-08 02:00 │ 每日巡检  │ 成功 │ 5min  │ 查看 │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  页面4: 系统设置 (Settings)                                  │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  Tab: 检测配置 │ 检测器管理 │ 系统信息                │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   │  检测配置:                                                   │   │   │
│   │   │  ┌───────────────────────────────────────────────────────┐   │   │   │
│   │   │  │  配置模板: [严格] [标准] [宽松] [自定义]              │   │   │   │
│   │   │  │                                                       │   │   │   │
│   │   │  │  模糊检测阈值:    [====●====] 100                     │   │   │   │
│   │   │  │  亮度范围:        [20] - [235]                        │   │   │   │
│   │   │  │  噪声阈值:        [====●====] 30                      │   │   │   │
│   │   │  │  ...                                                  │   │   │   │
│   │   │  │                                                       │   │   │   │
│   │   │  │  [恢复默认]  [保存配置]                                │   │   │   │
│   │   │  └───────────────────────────────────────────────────────┘   │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 组件设计

```
src/
├── App.vue
├── main.ts
├── router/
│   └── index.ts              # 路由配置
├── stores/
│   ├── detection.ts          # 检测状态管理
│   ├── task.ts               # 任务状态管理
│   └── config.ts             # 配置状态管理
├── api/
│   ├── detection.ts          # 检测相关 API
│   ├── task.ts               # 任务相关 API
│   └── config.ts             # 配置相关 API
├── views/
│   ├── Dashboard.vue         # 仪表盘页面
│   ├── Detection.vue         # 检测中心页面
│   ├── Tasks.vue             # 任务管理页面
│   └── Settings.vue          # 系统设置页面
├── components/
│   ├── common/
│   │   ├── AppHeader.vue     # 顶部导航
│   │   ├── FileUpload.vue    # 文件上传组件
│   │   └── ResultCard.vue    # 结果卡片组件
│   ├── detection/
│   │   ├── ImageDetector.vue # 单图检测组件
│   │   ├── BatchDetector.vue # 批量检测组件
│   │   ├── VideoDetector.vue # 视频检测组件
│   │   └── ResultViewer.vue  # 结果查看组件
│   ├── task/
│   │   ├── TaskList.vue      # 任务列表
│   │   ├── TaskForm.vue      # 任务表单
│   │   └── TaskHistory.vue   # 执行历史
│   └── settings/
│       ├── ThresholdConfig.vue    # 阈值配置
│       ├── DetectorManager.vue    # 检测器管理
│       └── SystemInfo.vue         # 系统信息
└── utils/
    ├── request.ts            # HTTP 请求封装
    └── formatter.ts          # 格式化工具
```

### 3.4 关键页面交互设计

#### 3.4.1 检测结果展示

```
┌─────────────────────────────────────────────────────────────────────┐
│                      图像检测结果详情                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────┐   ┌─────────────────────────────────────┐ │
│   │                     │   │                                     │ │
│   │                     │   │  诊断结果:  ⚠️ 检测到异常           │ │
│   │    图像预览区       │   │                                     │ │
│   │                     │   │  主要问题:  噪声干扰                │ │
│   │                     │   │                                     │ │
│   │                     │   │  严重程度:  ⚡ 警告                  │ │
│   │                     │   │                                     │ │
│   │                     │   │  处理耗时:  32.5ms                  │ │
│   │                     │   │                                     │ │
│   └─────────────────────┘   └─────────────────────────────────────┘ │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐
│   │  检测指标详情                                                   │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│   │  │ 🔍 模糊 │ │ ☀️ 亮度 │ │ 🎨 颜色 │ │ 📊 对比 │              │
│   │  │ 2367.8  │ │  105.4  │ │  21.9   │ │  54.5   │              │
│   │  │   ✅    │ │   ✅    │ │   ✅    │ │   ✅    │              │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│   │  │ 🔊 噪声 │ │ 📏 条纹 │ │ 🚧 遮挡 │ │ 📡 信号 │              │
│   │  │  32.6   │ │  0.02   │ │  0.08   │ │ 105.4   │              │
│   │  │   ⚠️    │ │   ✅    │ │   ✅    │ │   ✅    │              │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
│   └─────────────────────────────────────────────────────────────────┘
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐
│   │  💡 改进建议                                                    │
│   │  • 检查摄像头镜头是否清洁                                       │
│   │  • 调整摄像头增益设置                                           │
│   │  • 检查传输线路是否受到干扰                                     │
│   └─────────────────────────────────────────────────────────────────┘
│                                                                     │
│   [导出报告]  [重新检测]  [关闭]                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、定时任务模块设计

### 4.1 架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                      定时任务系统架构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    Scheduler Service                         │   │
│   │                                                             │   │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │   │
│   │   │  APScheduler│   │  Job Store  │   │  Executor   │      │   │
│   │   │  (调度引擎)  │   │ (任务存储)  │   │ (执行器)    │      │   │
│   │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘      │   │
│   │          │                 │                 │              │   │
│   │          └─────────────────┴─────────────────┘              │   │
│   │                           │                                 │   │
│   │                           ▼                                 │   │
│   │   ┌─────────────────────────────────────────────────────┐   │   │
│   │   │                  Job Registry                        │   │   │
│   │   │                                                     │   │   │
│   │   │   ┌───────────┐  ┌───────────┐  ┌───────────┐      │   │   │
│   │   │   │BatchDetect│  │SampleDetec│  │VideoDetect│      │   │   │
│   │   │   │   Job     │  │   Job     │  │   Job     │      │   │   │
│   │   │   └───────────┘  └───────────┘  └───────────┘      │   │   │
│   │   │                                                     │   │   │
│   │   └─────────────────────────────────────────────────────┘   │   │
│   │                                                             │   │
│   │   ┌─────────────────────────────────────────────────────┐   │   │
│   │   │                  Notification                        │   │   │
│   │   │   • 任务开始/完成通知                                │   │   │
│   │   │   • 异常告警通知（预留）                             │   │   │
│   │   └─────────────────────────────────────────────────────┘   │   │
│   │                                                             │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 任务数据模型

```python
from dataclasses import dataclass
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum

class TaskType(Enum):
    BATCH = "batch"        # 批量检测
    SAMPLE = "sample"      # 抽样检测
    VIDEO = "video"        # 视频检测

class TaskStatus(Enum):
    PENDING = "pending"        # 待执行
    RUNNING = "running"        # 执行中
    COMPLETED = "completed"    # 已完成
    FAILED = "failed"          # 失败
    DISABLED = "disabled"      # 已禁用

@dataclass
class ScheduledTask:
    """定时任务配置"""
    id: str                           # 任务ID
    name: str                         # 任务名称
    description: Optional[str]        # 任务描述
    task_type: TaskType               # 任务类型
    cron_expression: str              # Cron 表达式
    enabled: bool                     # 是否启用
    
    # 检测配置
    config: Dict[str, Any] = field(default_factory=dict)
    # {
    #     "input_path": "/data/images/",
    #     "pattern": "*.jpg",
    #     "profile": "normal",
    #     "level": "standard",
    #     "sample_rate": 0.1,  # 仅抽样任务
    #     "recursive": True
    # }
    
    # 输出配置
    output: Dict[str, Any] = field(default_factory=dict)
    # {
    #     "path": "/data/reports/",
    #     "format": ["json", "html", "excel"],
    #     "keep_days": 30
    # }
    
    # 元数据
    created_at: datetime
    updated_at: datetime
    last_run_at: Optional[datetime]
    next_run_at: Optional[datetime]

@dataclass
class TaskExecution:
    """任务执行记录"""
    id: str                           # 执行ID
    task_id: str                      # 任务ID
    task_name: str                    # 任务名称
    status: TaskStatus                # 执行状态
    
    # 执行结果
    started_at: datetime
    finished_at: Optional[datetime]
    duration_seconds: Optional[float]
    
    # 统计信息
    total_items: int = 0              # 总检测数
    normal_count: int = 0             # 正常数
    abnormal_count: int = 0           # 异常数
    error_count: int = 0              # 错误数
    
    # 结果文件
    report_path: Optional[str] = None
    
    # 错误信息
    error_message: Optional[str] = None
```

### 4.3 任务 API 设计

```python
# 任务管理 API

# GET /api/v1/tasks
# 获取任务列表
{
    "response": {
        "tasks": [
            {
                "id": "task-001",
                "name": "每日巡检",
                "task_type": "batch",
                "cron_expression": "0 2 * * *",
                "enabled": true,
                "last_run_at": "2024-01-08T02:00:00",
                "next_run_at": "2024-01-09T02:00:00"
            }
        ],
        "total": 5
    }
}

# POST /api/v1/tasks
# 创建任务
{
    "request": {
        "name": "每日巡检",
        "description": "每天凌晨2点执行全量图片检测",
        "task_type": "batch",
        "cron_expression": "0 2 * * *",
        "enabled": true,
        "config": {
            "input_path": "/data/images/",
            "pattern": "*.jpg",
            "profile": "normal",
            "level": "standard"
        },
        "output": {
            "path": "/data/reports/",
            "format": ["json", "html"]
        }
    }
}

# PUT /api/v1/tasks/{task_id}
# 更新任务

# DELETE /api/v1/tasks/{task_id}
# 删除任务

# POST /api/v1/tasks/{task_id}/run
# 立即执行任务

# POST /api/v1/tasks/{task_id}/enable
# 启用任务

# POST /api/v1/tasks/{task_id}/disable
# 禁用任务

# GET /api/v1/tasks/{task_id}/executions
# 获取执行历史
{
    "response": {
        "executions": [
            {
                "id": "exec-001",
                "task_id": "task-001",
                "status": "completed",
                "started_at": "2024-01-08T02:00:00",
                "finished_at": "2024-01-08T02:05:32",
                "duration_seconds": 332,
                "total_items": 1000,
                "normal_count": 980,
                "abnormal_count": 20
            }
        ]
    }
}
```

---

## 五、报告导出模块设计

### 5.1 报告格式

```
┌─────────────────────────────────────────────────────────────────────┐
│                      报告格式支持                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   格式        用途                 库                               │
│   ──────────────────────────────────────────────────────────────   │
│   JSON        程序集成             内置                             │
│   HTML        在线查看             Jinja2                           │
│   Excel       数据分析             openpyxl                         │
│   PDF         正式报告             reportlab / weasyprint           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 Excel 报告结构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Excel 报告结构                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Sheet 1: 摘要                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  检测报告摘要                                                │   │
│   │  ──────────────────────────────────────────────────────────│   │
│   │  检测时间:     2024-01-08 02:00:00                          │   │
│   │  检测总数:     1000                                         │   │
│   │  正常数量:     980                                          │   │
│   │  异常数量:     20                                           │   │
│   │  异常率:       2.0%                                         │   │
│   │  ──────────────────────────────────────────────────────────│   │
│   │  异常类型分布:                                               │   │
│   │  • 噪声干扰: 8                                              │   │
│   │  • 画面模糊: 5                                              │   │
│   │  • 亮度异常: 4                                              │   │
│   │  • 颜色偏差: 3                                              │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   Sheet 2: 异常详情                                                 │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  文件名    │ 主要问题 │ 严重程度 │ 得分  │ 建议              │   │
│   │  ─────────────────────────────────────────────────────────  │   │
│   │  img001.jpg│ 噪声干扰 │ 警告    │ 35.2  │ 检查设备...       │   │
│   │  img002.jpg│ 画面模糊 │ 严重    │ 45.6  │ 清洁镜头...       │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   Sheet 3: 全部结果                                                 │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  文件名    │状态│模糊 │亮度 │对比│颜色│噪声│条纹│遮挡│信号│   │
│   │  ─────────────────────────────────────────────────────────  │   │
│   │  img001.jpg│ ⚠️ │2367│105 │54  │21  │35  │0.02│0.08│105│   │
│   │  img002.jpg│ ✅ │1856│120 │62  │18  │12  │0.01│0.05│128│   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 六、项目结构更新

### 6.1 V1.5 目录结构

```
originx/
├── api/                          # API 层
│   ├── __init__.py
│   ├── main.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── diagnose.py
│   │   ├── video.py              # [新增] 视频检测路由
│   │   ├── stream.py             # [新增] 流检测路由
│   │   ├── baseline.py            # [新增] 基准图像路由
│   │   ├── tasks.py              # [新增] 任务管理路由
│   │   ├── config.py
│   │   ├── detectors.py
│   │   └── system.py
│   └── schemas/
│       ├── __init__.py
│       ├── request.py
│       ├── response.py
│       ├── video.py              # [新增] 视频相关 Schema
│       ├── stream.py              # [新增] 流检测相关 Schema
│       ├── baseline.py            # [新增] 基准图像相关 Schema
│       └── task.py               # [新增] 任务相关 Schema
│
├── cli/                          # CLI 层
│   ├── __init__.py
│   ├── main.py
│   └── commands/
│       ├── __init__.py
│       ├── detect.py
│       ├── video.py              # [新增] 视频检测命令
│       ├── stream.py             # [新增] 流检测命令
│       ├── baseline.py           # [新增] 基准对比命令
│       ├── task.py               # [新增] 任务管理命令
│       ├── serve.py
│       ├── config.py
│       └── benchmark.py
│
├── core/                         # 核心层
│   ├── __init__.py
│   ├── base.py
│   ├── registry.py
│   ├── pipeline.py
│   ├── video_pipeline.py         # [新增] 视频处理流水线
│   ├── detectors/
│   │   ├── __init__.py
│   │   ├── blur_detector.py
│   │   ├── brightness_detector.py
│   │   ├── color_detector.py
│   │   ├── contrast_detector.py
│   │   ├── noise_detector.py
│   │   ├── stripe_detector.py
│   │   ├── occlusion_detector.py
│   │   ├── signal_loss_detector.py
│   │   └── video/                # [新增] 视频检测器目录
│   │       ├── __init__.py
│   │       ├── base.py
│   │       ├── freeze_detector.py
│   │       ├── scene_change_detector.py
│   │       └── shake_detector.py
│   └── utils/
│       ├── __init__.py
│       ├── image_utils.py
│       ├── video_utils.py        # [新增] 视频处理工具
│       └── metrics.py
│
├── services/                     # 服务层
│   ├── __init__.py
│   ├── diagnosis_service.py
│   ├── video_service.py          # [新增] 视频服务
│   ├── stream_service.py         # [新增] 流检测服务
│   ├── baseline_service.py       # [新增] 基准图像服务
│   ├── scheduler_service.py      # [新增] 调度服务
│   └── report_service.py         # [新增] 报告服务
│
├── scheduler/                    # [新增] 定时任务模块
│   ├── __init__.py
│   ├── scheduler.py
│   ├── jobs/
│   │   ├── __init__.py
│   │   ├── base.py
│   │   ├── batch_detect_job.py
│   │   ├── sample_detect_job.py
│   │   └── video_detect_job.py
│   └── store/
│       ├── __init__.py
│       └── file_store.py         # 文件存储（V1.5 使用）
│
├── reports/                      # [新增] 报告模块
│   ├── __init__.py
│   ├── base.py
│   ├── json_reporter.py
│   ├── html_reporter.py
│   ├── excel_reporter.py
│   └── pdf_reporter.py
│
├── web/                          # [新增] Web UI
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   ├── index.html
│   └── src/
│       ├── App.vue
│       ├── main.ts
│       ├── router/
│       ├── stores/
│       ├── api/
│       ├── views/
│       ├── components/
│       └── utils/
│
├── config/
│   ├── __init__.py
│   ├── settings.py
│   ├── default.yaml
│   └── tasks.yaml                # [新增] 任务配置
│
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_detectors.py
│   ├── test_pipeline.py
│   ├── test_video_detectors.py   # [新增]
│   ├── test_video_pipeline.py    # [新增]
│   ├── test_stream_detector.py   # [新增]
│   ├── test_baseline_comparison.py # [新增]
│   ├── test_scheduler.py         # [新增]
│   └── test_reports.py           # [新增]
│
├── doc/
├── examples/
├── Dockerfile
├── docker-compose.yml
├── Makefile
├── README.md
├── requirements.txt
├── requirements-dev.txt
├── pyproject.toml
└── setup.py
```

---

## 七、开发计划

### 7.1 里程碑规划

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          V1.5 开发里程碑                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Week 1-2                Week 3-4                Week 5-6                  │
│   ┌─────────┐             ┌─────────┐             ┌─────────┐              │
│   │ M1      │────────────▶│ M2      │────────────▶│ M3      │              │
│   │视频检测 │             │ Web UI  │             │定时任务 │              │
│   └─────────┘             └─────────┘             └─────────┘              │
│                                                                             │
│   Week 7                  Week 8                  Week 9-10                 │
│   ┌─────────┐             ┌─────────┐             ┌─────────┐              │
│   │ M4      │────────────▶│ M5      │────────────▶│ M6      │              │
│   │报告导出 │             │优化完善 │             │测试发布 │              │
│   └─────────┘             └─────────┘             └─────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 详细开发计划

| 阶段 | 周 | 任务 | 交付物 | 负责人 | 状态 |
|------|-----|------|--------|--------|------|
| **M1: 视频检测** | | | | | |
| | W1-D1~D2 | 视频处理框架 | VideoLoader, FrameSampler | - | ✅ |
| | W1-D3~D5 | FreezeDetector | 画面冻结检测器 | - | ✅ |
| | W2-D1~D3 | SceneChangeDetector | 场景变换检测器 | - | ✅ |
| | W2-D4~D5 | ShakeDetector | 视频抖动检测器 | - | ✅ |
| **M2: Web UI** | | | | | |
| | W3-D1~D2 | 项目搭建 | Vue3 + Element Plus 脚手架 | - | ✅ |
| | W3-D3~D5 | 仪表盘页面 | Dashboard.vue | - | ✅ |
| | W4-D1~D3 | 检测中心页面 | Detection.vue (含视频) | - | ✅ |
| | W4-D4~D5 | 任务管理页面 | Tasks.vue | - | ✅ |
| **M3: 定时任务** | | | | | |
| | W5-D1~D2 | 调度框架 | APScheduler 集成 | - | ✅ |
| | W5-D3~D5 | 任务存储 | FileStore + YAML | - | ✅ |
| | W6-D1~D3 | 任务 API | CRUD + 执行历史 | - | ✅ |
| | W6-D4~D5 | 系统设置页面 | Settings.vue | - | ✅ |
| **M4: 报告导出** | | | | | |
| | W7-D1~D2 | Excel 报告 | openpyxl 集成 | - | ✅ |
| | W7-D3~D4 | PDF 报告 | reportlab 集成 | - | ✅ |
| | W7-D5 | HTML 模板优化 | Jinja2 模板 | - | ✅ |
| **M5: 优化完善** | | | | | |
| | W8-D1~D2 | 性能优化 | 视频处理性能调优 | - | ⏳ |
| | W8-D3~D4 | 算法调优 | 基于测试数据优化阈值 | - | ⏳ |
| | W8-D5 | 文档完善 | API文档、用户指南 | - | ✅ |
| **M6: 测试发布** | | | | | |
| | W9-D1~D3 | 单元测试 | 覆盖率 > 80% | - | ⏳ |
| | W9-D4~D5 | 集成测试 | E2E 测试 | - | ⏳ |
| | W10-D1~D2 | Bug 修复 | 修复测试发现的问题 | - | ⏳ |
| | W10-D3~D4 | 文档更新 | README、CHANGELOG | - | ✅ |
| | W10-D5 | 版本发布 | V1.5.0 Tag | - | ⏳ |

### 7.3 技术依赖清单

```
# requirements.txt (V1.5 新增)

# 视频处理
opencv-python>=4.8.0
numpy>=1.24.0
scikit-image>=0.21.0  # SSIM 计算
ffmpeg-python>=0.2.0  # 流处理（可选）

# 定时任务
apscheduler>=3.10.0

# 报告生成
openpyxl>=3.1.0          # Excel
reportlab>=4.0.0         # PDF
jinja2>=3.1.0            # HTML 模板

# Web UI 构建（可选，开发时需要）
# Node.js >= 18.x
# npm >= 9.x
```

---

## 八、测试策略

### 8.1 测试分层

```
┌─────────────────────────────────────────────────────────────────────┐
│                        测试金字塔                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                         ┌─────────┐                                 │
│                         │   E2E   │  10%                            │
│                         │  Tests  │  (Web UI 流程)                  │
│                         └────┬────┘                                 │
│                    ┌─────────┴─────────┐                           │
│                    │   Integration     │  30%                       │
│                    │      Tests        │  (API + Pipeline)          │
│                    └─────────┬─────────┘                           │
│            ┌─────────────────┴─────────────────┐                   │
│            │           Unit Tests              │  60%               │
│            │   (Detectors, Utils, Services)    │                   │
│            └───────────────────────────────────┘                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 8.2 视频检测测试用例

```python
# tests/test_video_detectors.py

class TestFreezeDetector:
    """画面冻结检测器测试"""
    
    def test_detect_freeze_normal_video(self, normal_video_frames):
        """测试正常视频不应检测出冻结"""
        detector = FreezeDetector()
        result = detector.detect(normal_video_frames, fps=30)
        assert result.is_abnormal == False
    
    def test_detect_freeze_frozen_video(self, frozen_video_frames):
        """测试包含冻结的视频应正确检测"""
        detector = FreezeDetector()
        result = detector.detect(frozen_video_frames, fps=30)
        assert result.is_abnormal == True
        assert len(result.segments) > 0
    
    def test_detect_freeze_duration(self, frozen_video_frames):
        """测试冻结时长计算正确"""
        detector = FreezeDetector(config={"min_freeze_frames": 15})
        result = detector.detect(frozen_video_frames, fps=30)
        # 验证时长计算
        assert result.evidence["total_freeze_duration"] > 0.5
    
    def test_ignore_short_freeze(self, short_freeze_frames):
        """测试忽略短暂的相似帧"""
        detector = FreezeDetector(config={"min_freeze_frames": 30})
        result = detector.detect(short_freeze_frames, fps=30)
        # 不足1秒的相似不应被检测为冻结
        assert result.is_abnormal == False


class TestSceneChangeDetector:
    """场景变换检测器测试"""
    
    def test_detect_no_scene_change(self, stable_video_frames):
        """测试稳定场景不应检测出变化"""
        detector = SceneChangeDetector()
        result = detector.detect(stable_video_frames, fps=30)
        assert result.is_abnormal == False
    
    def test_detect_scene_change(self, scene_change_frames):
        """测试场景变换应正确检测"""
        detector = SceneChangeDetector()
        result = detector.detect(scene_change_frames, fps=30)
        assert len(result.segments) > 0


class TestShakeDetector:
    """视频抖动检测器测试"""
    
    def test_detect_stable_video(self, stable_video_frames):
        """测试稳定视频不应检测出抖动"""
        detector = ShakeDetector()
        result = detector.detect(stable_video_frames, fps=30)
        assert result.is_abnormal == False
    
    def test_detect_shaky_video(self, shaky_video_frames):
        """测试抖动视频应正确检测"""
        detector = ShakeDetector()
        result = detector.detect(shaky_video_frames, fps=30)
        assert result.is_abnormal == True
```

---

## 九、风险评估

### 9.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 视频处理性能不达标 | 中 | 高 | 1. 预处理降采样<br>2. 多进程处理<br>3. 可配置采样策略 |
| 视频检测准确率不足 | 中 | 高 | 1. 多算法融合<br>2. 参数可配置<br>3. 收集反馈迭代 |
| Web UI 兼容性问题 | 低 | 中 | 1. 主流浏览器测试<br>2. 响应式设计 |
| APScheduler 稳定性 | 低 | 中 | 1. 任务持久化<br>2. 失败重试<br>3. 监控告警 |

### 9.2 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 视频模块开发延期 | 中 | 高 | 预留缓冲时间，可降级为2个检测器 |
| Web UI 工作量超预期 | 中 | 中 | 可先发布基础版本，后续迭代 |
| 测试时间不足 | 中 | 中 | 边开发边测试，不堆积到最后 |

---

## 十、验收标准

### 10.1 功能验收

| 功能 | 验收标准 |
|------|----------|
| 视频检测 | 支持 MP4/AVI/MOV 格式，5分钟视频处理 < 30秒 |
| 画面冻结检测 | 准确率 > 90%，1秒以上冻结100%检出 |
| 场景变换检测 | 准确率 > 85%，明显变化100%检出 |
| 视频抖动检测 | 准确率 > 85%，剧烈抖动100%检出 |
| Web UI | 4个页面可正常使用，Chrome/Firefox 兼容 |
| 定时任务 | 支持 Cron 表达式，执行误差 < 1分钟 |
| Excel 报告 | 正确生成摘要、异常、全部结果三个 Sheet |

### 10.2 性能验收

| 指标 | 目标 |
|------|------|
| 视频处理吞吐 | > 2x 实时（1分钟视频 < 30秒处理完） |
| Web UI 首屏加载 | < 3秒 |
| API 响应时间 | 非检测请求 < 100ms |
| 内存占用 | 视频处理时 < 2GB |

---

## 附录

### A. Cron 表达式参考

```
┌───────────── 分钟 (0-59)
│ ┌───────────── 小时 (0-23)
│ │ ┌───────────── 日 (1-31)
│ │ │ ┌───────────── 月 (1-12)
│ │ │ │ ┌───────────── 星期 (0-6, 0=周日)
│ │ │ │ │
│ │ │ │ │
* * * * *

常用示例：
0 2 * * *      每天凌晨2点
0 */4 * * *    每4小时
0 9,18 * * 1-5 工作日9点和18点
*/10 * * * *   每10分钟
```

### B. 视频格式支持

| 格式 | 容器 | 编码 | 支持状态 |
|------|------|------|----------|
| MP4 | MPEG-4 | H.264, H.265 | ✅ |
| AVI | AVI | 多种 | ✅ |
| MOV | QuickTime | H.264 | ✅ |
| MKV | Matroska | 多种 | ✅ |
| WEBM | WebM | VP8, VP9 | ✅ |
| FLV | Flash | H.264 | ⚠️ 部分支持 |

---

*文档版本：1.0*
*更新日期：2026年1月*
*作者：技术架构组*

